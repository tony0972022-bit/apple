<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç‡Ÿé‹è¨˜å¸³åŠ©ç† - ä»‹é¢ç²¾ç°¡ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥è¾²æ›†è½‰æ›åº« (ç¢ºä¿è¼‰å…¥) -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, setDoc, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWrfJ0OkCIMOJw39_HYq4gjTzPP70LODY",
            authDomain: "apple-bf8b5.firebaseapp.com",
            projectId: "apple-bf8b5",
            storageBucket: "apple-bf8b5.firebasestorage.app",
            messagingSenderId: "3201276074",
            appId: "1:3201276074:web:5692b56fcb5ec5b6b758d3",
            measurementId: "G-XE39NRPN02"
        };
        
        let myApiKey = localStorage.getItem('user_gemini_api_key') || "";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "family-accounting-app"; 

        let currentUser = null;
        let records = [];
        let itemMappings = [];
        // Work Session & Forecasts
        let workSessions = []; 
        let currentWorkSession = null; 
        let todaySession = null; 
        let forecastHistory = [];

        // Automation Flags
        let autoAction = new URLSearchParams(window.location.search).get('action'); // 'start' or 'end'
        let hasProcessedAutoAction = false; 

        // Time Adjustment State
        let pendingTimeAction = null; // 'start', 'end', 'edit_start', 'edit_end'
        let pendingSessionId = null;

        // Charts
        let trendChartInstance = null;
        let weekdayChartInstance = null;

        let currentEditId = null;
        let currentAnalysisResult = "";
        let pendingDeleteId = null;
        
        // Chat
        let chatHistory = [];

        // Tainan Coordinates
        const TAINAN_LAT = 22.9997;
        const TAINAN_LON = 120.2270;

        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('initial-loader');
            if(loader) loader.classList.remove('hidden');
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const calendarInput = document.getElementById('calendar-month-picker');
            if(calendarInput) calendarInput.value = monthStr;
            
            // å•Ÿå‹•å·¦ä¸Šè§’æ™‚é˜ (ç«‹å³åŸ·è¡Œä¸€æ¬¡ï¼Œä¹‹å¾Œæ¯ç§’æ›´æ–°)
            updateHeaderClock();
            setInterval(updateHeaderClock, 1000);
        });

        // å·¦ä¸Šè§’æ™‚é˜æ›´æ–°å‡½å¼
        function updateHeaderClock() {
            const clockEl = document.getElementById('header-clock');
            if(!clockEl) return;

            const now = new Date();
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const day = days[now.getDay()];
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            
            let lunarStr = "";
            try {
                if (typeof Lunar !== 'undefined') {
                    const d = Lunar.fromDate(now);
                    lunarStr = `è¾²æ›†${d.getMonthInChinese()}æœˆ${d.getDayInChinese()}`;
                    const jieqi = d.getJieQi();
                    if(jieqi) lunarStr += ` â€¢ ${jieqi}`;
                    
                    const todayLunarInfo = document.getElementById('today-lunar-info');
                    if(todayLunarInfo && todayLunarInfo.innerHTML === "") {
                          todayLunarInfo.innerText = `${yyyy}/${mm}/${dd} ${lunarStr}`;
                    }
                }
            } catch(e) { console.warn("Lunar error:", e); }

            clockEl.innerHTML = `
                <span class="mr-1 font-mono">${yyyy}/${mm}/${dd} (${day})</span>
                <span class="font-bold mr-2 font-mono">${hh}:${min}</span>
                <span class="text-yellow-200 text-xs">${lunarStr}</span>
            `;
        }

        signInAnonymously(auth).catch(e => console.warn("Auth:", e));

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                const loader = document.getElementById('initial-loader');
                if(loader) loader.classList.add('hidden');

                // ç›£è½è¨˜å¸³ç´€éŒ„
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'records'), (snapshot) => {
                    records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    records.sort((a, b) => new Date(b.date) - new Date(a.date));
                    updateFilterOptions();
                    updateWorkStatsFilterOptions(); 
                    
                    const activeBtn = document.querySelector('button[class*="bg-blue-600"]');
                    if(activeBtn) {
                        const currentTab = activeBtn.id.replace('btn-tab-', '');
                        if (currentTab === 'report') renderReport();
                        if (currentTab === 'stats') renderItemStats();
                        if (currentTab === 'calendar') renderCalendar();
                        if (currentTab === 'work') renderWorkStatsTable(); 
                    }
                });

                // ç›£è½å°ç…§è¡¨
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'item_mappings'), (snapshot) => {
                    itemMappings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMappingList();
                });

                // ç›£è½æ‰€æœ‰å·¥ä½œç‹€æ…‹
                const qAllWork = query(collection(db, 'artifacts', appId, 'public', 'data', 'work_sessions'), orderBy("startTime", "desc"));
                onSnapshot(qAllWork, (snapshot) => {
                    workSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // ä¿®æ­£ï¼šä½¿ç”¨å°ç£æ™‚é–“ä¾†åˆ¤æ–·ã€Œä»Šå¤©ã€
                    const now = new Date();
                    const todayStr = toTaiwanDate(now.toISOString());
                    
                    const latestSession = workSessions.length > 0 ? workSessions[0] : null;
                    
                    currentWorkSession = null;
                    todaySession = null;

                    if (latestSession) {
                        const startObj = toTaiwanDate(latestSession.startTime);
                        const isRunning = !latestSession.endTime;
                        
                        // å–å¾—æ”¶æ”¤æ—¥æœŸçš„å°ç£æ™‚é–“å­—ä¸² (å¦‚æœå·²æ”¶æ”¤)
                        let endObj = "";
                        if (latestSession.endTime) {
                            endObj = toTaiwanDate(latestSession.endTime);
                        }

                        // é‚è¼¯å„ªåŒ–ï¼šæ”¾å¯¬é¡¯ç¤ºæ¨™æº–
                        if (isRunning || startObj === todayStr || endObj === todayStr) {
                            todaySession = latestSession;
                            if (isRunning) {
                                currentWorkSession = latestSession;
                            }
                        }
                    }
                    
                    renderWorkStatus(); 
                    renderWorkStatsTable(); 

                    // è‡ªå‹•åŒ–æ‰“å¡é‚è¼¯
                    if (autoAction && !hasProcessedAutoAction) {
                        hasProcessedAutoAction = true;
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);

                        if (autoAction === 'start') {
                            if (!currentWorkSession) {
                                showToast("ğŸš— åµæ¸¬åˆ°åˆ°é”æ”¤ä½ï¼Œè‡ªå‹•é–‹å§‹ç‡Ÿæ¥­ï¼");
                                switchTab('work');
                                window.startWork(true); 
                            } else {
                                showToast("âš ï¸ å·²ç¶“åœ¨ç‡Ÿæ¥­ä¸­å›‰ï¼");
                            }
                        } else if (autoAction === 'end') {
                            if (currentWorkSession) {
                                showToast("ğŸš— åµæ¸¬åˆ°é›¢é–‹æ”¤ä½ï¼Œè‡ªå‹•çµæŸç‡Ÿæ¥­ï¼");
                                switchTab('work');
                                window.endWork(true);
                            } else {
                                showToast("âš ï¸ ç›®å‰æ²’æœ‰é–‹æ”¤ç´€éŒ„ï¼Œç„¡æ³•è‡ªå‹•æ”¶æ”¤ã€‚", "error");
                            }
                        }
                    }
                });

                // ç›£è½è²·æ°£é æ¸¬ç´€éŒ„
                const qForecast = query(collection(db, 'artifacts', appId, 'public', 'data', 'daily_forecasts'), orderBy("targetDate", "asc"));
                onSnapshot(qForecast, (snapshot) => {
                    forecastHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderForecastUI(); 
                    renderWorkStatsTable();
                    checkAutoForecast(); 
                });

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main'), (docSnap) => {
                    if (docSnap.exists() && docSnap.data().gemini_api_key) {
                        const cloudKey = docSnap.data().gemini_api_key;
                        if (cloudKey !== myApiKey) {
                            console.log("â˜ï¸ å·²å¾é›²ç«¯åŒæ­¥ API Key");
                            myApiKey = cloudKey;
                            localStorage.setItem('user_gemini_api_key', cloudKey);
                        }
                    }
                });
            }
        });

        // ğŸŸ¢ è¼”åŠ©å‡½å¼ï¼šå°‡ ISO æ™‚é–“å­—ä¸²è½‰ç‚º å°ç£æ—¥æœŸå­—ä¸² (YYYY-MM-DD)
        function toTaiwanDate(isoStr) {
            if(!isoStr) return "";
            const date = new Date(isoStr);
            const utc = date.getTime(); 
            const offset = 8 * 60 * 60 * 1000;
            const taiwanDate = new Date(utc + offset);
            return taiwanDate.toISOString().split('T')[0];
        }

        async function fetchTainanWeather() {
            // å¢åŠ  uv_index_max
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${TAINAN_LAT}&longitude=${TAINAN_LON}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode,uv_index_max&timezone=Asia%2FTaipei&past_days=2&forecast_days=8`;
            const resp = await fetch(url);
            return await resp.json();
        }

        // ğŸŸ¢ æ–°å¢ï¼šå¼·åˆ¶é‡æ–°é å ±åŠŸèƒ½çš„æŒ‰éˆ•é‚è¼¯
        window.retryForecast = async (dateStr, btnId) => {
            const btn = document.getElementById(btnId);
            const originalText = btn ? btn.innerHTML : "ğŸ”„ é‡æ–°é å ±";
            
            if(btn) {
                btn.innerHTML = "â³ å…’å­æ€è€ƒä¸­...";
                btn.disabled = true;
                btn.classList.add("cursor-not-allowed", "opacity-70");
            }

            try {
                console.log(`Manually retrying forecast for: ${dateStr}`);
                await window.runAiForecast(dateStr, false);
            } catch(e) {
                console.error("Retry failed:", e);
                showToast("é‡æ–°é å ±å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key", "error");
            } finally {
                if(btn && document.body.contains(btn)) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove("cursor-not-allowed", "opacity-70");
                }
            }
        };

        async function checkAutoForecast() {
            const today = new Date();
            const aiTargets = [];
            for(let i=0; i<3; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                aiTargets.push(toTaiwanDate(d.toISOString()));
            }
            const todayStr = toTaiwanDate(today.toISOString());
            const todayForecast = forecastHistory.find(f => f.targetDate === todayStr);
            let needWeatherUpdate = false;
            const currentHour = today.getHours();
            if (!todayForecast) {
                needWeatherUpdate = true;
            } else if (todayForecast.queryTime) {
                const lastUpdate = new Date(todayForecast.queryTime);
                if (currentHour >= 12 && lastUpdate.getHours() < 12) {
                     needWeatherUpdate = true;
                     console.log("ğŸ•› è¶…é 12 é»ï¼ŒåŸ·è¡Œæ¯æ—¥ä¾‹è¡Œå¤©æ°£æ›´æ–°...");
                }
            }
            if (needWeatherUpdate) {
                await updateWeekWeather();
            }
            for (const targetDate of aiTargets) {
                const forecast = forecastHistory.find(f => f.targetDate === targetDate);
                if (!forecast || !forecast.aiPrediction) {
                    console.log(`ğŸ¤– è‡ªå‹•è£œé½Š AI é æ¸¬: ${targetDate}`);
                    await runAiForecast(targetDate, true);
                }
            }
        }

        async function updateWeekWeather() {
            try {
                const weatherData = await fetchTainanWeather();
                const daily = weatherData.daily;
                const batchPromises = daily.time.map(async (dateStr, i) => {
                    const w = {
                        date: dateStr,
                        tempMax: daily.temperature_2m_max[i],
                        tempMin: daily.temperature_2m_min[i],
                        rainProb: daily.precipitation_probability_max[i],
                        windSpeed: daily.windspeed_10m_max[i],
                        weatherCode: daily.weathercode[i],
                        uvIndex: daily.uv_index_max[i]
                    };
                    let windLevel = "å¾®é¢¨";
                    if (w.windSpeed > 10) windLevel = "å°é¢¨";
                    if (w.windSpeed > 20) windLevel = "ä¸­é¢¨";
                    if (w.windSpeed > 30) windLevel = "å¼·é¢¨";
                    const existing = forecastHistory.find(f => f.targetDate === dateStr);
                    const aiPrediction = existing ? existing.aiPrediction : null;
                    const forecastData = {
                        queryTime: new Date().toISOString(),
                        targetDate: dateStr,
                        location: "å°ç£å°å—å¸‚",
                        weather: { ...w, windLevel },
                        aiPrediction: aiPrediction
                    };
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_forecasts', dateStr), forecastData);
                });
                await Promise.all(batchPromises);
                console.log("âœ… ä¸€é€±å¤©æ°£è³‡æ–™å·²æ›´æ–°");
            } catch(e) {
                console.error("æ›´æ–°å¤©æ°£å¤±æ•—", e);
            }
        }

        window.runAiForecast = async (targetDateStr, isAuto = false) => {
            let forecast = forecastHistory.find(f => f.targetDate === targetDateStr);
            if (!forecast) {
                await updateWeekWeather();
                const weatherData = await fetchTainanWeather(); 
                const idx = weatherData.daily.time.indexOf(targetDateStr);
                if(idx === -1) {
                    if(!isAuto) showToast(`âŒ æ‰¾ä¸åˆ° ${targetDateStr} çš„å¤©æ°£è³‡æ–™`, "error");
                    return;
                }
                forecast = { weather: {
                    date: weatherData.daily.time[idx],
                    tempMax: weatherData.daily.temperature_2m_max[idx],
                    tempMin: weatherData.daily.temperature_2m_min[idx],
                    rainProb: weatherData.daily.precipitation_probability_max[idx],
                    windSpeed: weatherData.daily.windspeed_10m_max[idx],
                    weatherCode: weatherData.daily.weathercode[idx],
                    uvIndex: weatherData.daily.uv_index_max[idx]
                }};
            } else {
                if(!forecast.weather) {
                     await updateWeekWeather();
                     return;
                }
            }

            const w = forecast.weather;
            let windLevel = "å¾®é¢¨";
            if (w.windSpeed > 10) windLevel = "å°é¢¨";
            if (w.windSpeed > 20) windLevel = "ä¸­é¢¨";
            if (w.windSpeed > 30) windLevel = "å¼·é¢¨";

            let lunarInfo = "";
            let worshipContext = "å¹³æ—¥";
            try {
                if (typeof Lunar !== 'undefined') {
                    const parts = targetDateStr.split('-');
                    const tDate = new Date(parts[0], parts[1]-1, parts[2]);
                    const lunarDate = Lunar.fromDate(tDate);
                    lunarInfo = `è¾²æ›†${lunarDate.getMonthInChinese()}æœˆ${lunarDate.getDayInChinese()}`;

                    const tNext1 = new Date(tDate); tNext1.setDate(tDate.getDate() + 1);
                    const lNext1 = Lunar.fromDate(tNext1);
                    const tNext2 = new Date(tDate); tNext2.setDate(tDate.getDate() + 2);
                    const lNext2 = Lunar.fromDate(tNext2);

                    const isSpecialDay = (d) => d.getDay() === 1 || d.getDay() === 15; 

                    if (isSpecialDay(lNext1)) {
                        worshipContext = `ğŸ”¥ğŸ”¥ é‡é»æ³¨æ„ï¼šæ˜å¤©æ˜¯è¾²æ›†${lNext1.getDayInChinese()} (æ‹œæ‹œæ—¥)ï¼ä¾ç…§ç¿’ä¿—ï¼Œä»Šå¤©æœƒæœ‰å¤§é‡å©†å©†åª½åª½å‡ºä¾†è²·æ°´æœæ‹œæ‹œï¼Œäººæ½®é æœŸæœƒå¤§å¢ã€‚`;
                    } else if (isSpecialDay(lNext2)) {
                        worshipContext = `ğŸ”¥ æ³¨æ„ï¼šå¾Œå¤©æ˜¯è¾²æ›†${lNext2.getDayInChinese()} (æ‹œæ‹œæ—¥)ï¼ä¾ç…§ç¿’ä¿—ï¼Œä»Šå¤©é–‹å§‹æœƒæœ‰äººæ½®æå‰æ¡è²·æ°´æœï¼Œè²·æ°£æœƒé€æ¼¸å‡æº«ã€‚`;
                    } else {
                        const jieqi = lunarDate.getJieQi();
                        if (jieqi) worshipContext += ` (ä»Šæ—¥ç¯€æ°£ï¼š${jieqi})`;
                    }
                }
            } catch (e) { console.warn("Lunar calc error", e); }

            const now = new Date();
            const todayStr = toTaiwanDate(now.toISOString());
            const tmrDate = new Date(now); tmrDate.setDate(tmrDate.getDate() + 1);
            const tmrStr = toTaiwanDate(tmrDate.toISOString());

            let relativeDayTerm = "é€™ä¸€å¤©";
            if (targetDateStr === todayStr) relativeDayTerm = "ä»Šå¤©";
            else if (targetDateStr === tmrStr) relativeDayTerm = "æ˜å¤©";

            const prompt = `
            ä½ æ˜¯é€™å®¶æ°´æœæ”¤è€é—†å¨˜çš„è²¼å¿ƒå…’å­ï¼Œæ­£åœ¨å¹«åª½åª½åˆ†æç”Ÿæ„ã€‚è«‹æ ¹æ“šä»¥ä¸‹ã€å¤©æ°£ã€‘èˆ‡ã€å°ç£æ‹œæ‹œç¿’ä¿—ã€‘ï¼Œé æ¸¬ã€Œ${relativeDayTerm} (${w.date})ã€çš„å¸‚å ´è²·æ°£ã€‚
            
            ã€æ°£è±¡æ•¸æ“šã€‘
            - æ¸…æ™¨æ°£æº«: ${w.tempMin}Â°C
            - ç™½å¤©æ°£æº«: ${w.tempMax}Â°C
            - ä¸‹é›¨æ©Ÿç‡: ${w.rainProb}% (é¢¨é€Ÿ: ${windLevel})
            - ç´«å¤–ç·šæŒ‡æ•¸: ${w.uvIndex} (è‹¥å¤§æ–¼7ç®—å¼·ï¼Œå¤§æ–¼10æ¥µå¼·)

            ã€è¾²æ›†èˆ‡ç¿’ä¿—æƒ…å ±ã€‘
            - ç•¶æ—¥: ${lunarInfo}
            - æ‹œæ‹œè²·æ°£åˆ†æ: ${worshipContext}
            
            ã€åˆ¤æ–·é‚è¼¯ã€‘
            1. **æ‹œæ‹œæ—¥å„ªå…ˆ**ï¼šå°ç£ç¿’ä¿—ä¸­ï¼Œè¾²æ›†åˆä¸€ã€åäº”æˆ–å¤§ç¯€æ—¥çš„å‰ 1-2 å¤©ï¼Œè²·æ°´æœæ‹œæ‹œæ˜¯å‰›æ€§éœ€æ±‚ã€‚å³ä½¿å¤©æ°£ç¨å¾®ä¸å¥½(å°é›¨)ï¼Œè²·æ°£ä¾ç„¶æœƒå¾ˆå¼·ï¼ˆå› ç‚ºä¸€å®šè¦æ‹œï¼‰ã€‚
            2. **å¤©æ°£å½±éŸ¿**ï¼šè‹¥ç„¡æ‹œæ‹œéœ€æ±‚ï¼Œå‰‡ä¸»è¦çœ‹å¤©æ°£ã€‚å¤§é›¨æˆ–å¯’æµæœƒé™ä½è²·æ°£ï¼›å¤©æ°£ç†±å‰‡æ¶ˆæš‘æ°´æœå¥½è³£ã€‚
            
            è«‹ç”¨è²¼å¿ƒã€å­é †çš„å£å»ï¼ˆåƒæ˜¯å…’å­å°åª½åª½èªªè©±ï¼‰ã€‚
            è«‹å›å‚³ JSON æ ¼å¼ (ä¸è¦ Markdown)ï¼ŒåŒ…å«ï¼š
            1. buyingMood (string): é«˜ / ä¸­ / ä½ (è‹¥é‡æ‹œæ‹œæ—¥å‰å¤•ï¼Œè«‹å‚¾å‘è©•ä¼°ç‚ºã€Œé«˜ã€æˆ–ã€Œä¸­é«˜ã€)
            2. moodReason (string): è«‹åŒ…å«ä¸‰é»å…§å®¹ï¼š(1)ç°¡å–®å¤©æ°£èªªæ˜ (2)ç¯€æ°£æˆ–æ‹œæ‹œå½±éŸ¿ (3)çµ¦åª½åª½çš„æ³¨æ„äº‹é …ã€‚
               * ğŸ”¥ é‡è¦æ™‚é–“ä¿®æ­£ï¼šé€™ä»½é å ±æ˜¯é‡å°ã€Œ${relativeDayTerm}ã€ã€‚åœ¨èªªæ˜æ™‚ï¼Œè«‹å‹™å¿…ä½¿ç”¨ã€Œ${relativeDayTerm}ã€é€™å€‹è©é–‹é ­ï¼ˆä¾‹å¦‚ï¼šåª½ï¼Œ${relativeDayTerm}çš„å¤©æ°£...ï¼‰ï¼Œçµ•å°ä¸èƒ½å¯«éŒ¯æ—¥æœŸï¼
               * ğŸ”¥ é‡è¦èªæ°£ä¿®æ­£ï¼šå¦‚æœé æ¸¬ç”Ÿæ„å¾ˆå¥½(é«˜)ï¼Œè«‹é«”è²¼åœ°èªªï¼šã€Œåª½${relativeDayTerm}æœƒå¾ˆå¿™ï¼Œè¾›è‹¦äº†ï¼Œè¦æ³¨æ„å®‰å…¨ä¸è¦å¤ªç´¯å–”ã€æˆ–ã€Œæ¬é‡ç‰©è¦å°å¿ƒï¼Œè…°è¦æ³¨æ„ã€ï¼Œçµ•å°ä¸è¦èªªã€Œå¦³ä¸€å®šæœƒå¿™ä¸éä¾†ã€é€™ç¨®è®“äººå£“åŠ›çš„è©±ã€‚
               * â˜€ï¸ ç´«å¤–ç·šæé†’ï¼šå¦‚æœç´«å¤–ç·šæŒ‡æ•¸é«˜(>6)ï¼Œè«‹æé†’åª½åª½è¦é˜²æ›¬ã€æˆ´å¸½å­æˆ–å¤šå–æ°´ã€‚
               * è«‹ç”¨æº«æš–å£å»æ•´åˆæˆä¸€æ®µè©± (50å­—å…§)ã€‚
            3. recommendedFruits (array of strings): æ¨è–¦ 5 æ¨£é©åˆç•¶å¤©è²©å”®çš„æ°´æœ (è‹¥é‡æ‹œæ‹œæ—¥ï¼Œè«‹æ¨è–¦ è˜‹æœ/é³³æ¢¨/é¦™è•‰ ç­‰é©åˆä¾›æ¡Œçš„æ°´æœ)
            `;
            try {
                const aiResp = await callGeminiAPI(prompt, null);
                const aiJson = JSON.parse(aiResp.replace(/```json|```/gi, "").trim());
                const forecastData = {
                    queryTime: new Date().toISOString(),
                    targetDate: w.date,
                    location: "å°ç£å°å—å¸‚",
                    weather: { ...w, windLevel },
                    aiPrediction: aiJson
                };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_forecasts', targetDateStr), forecastData);
                if (!isAuto) showToast(`âœ… ${targetDateStr} åˆ†æå®Œæˆï¼Œåª½åª½è«‹éç›®ï¼`);
            } catch (e) {
                console.error(e);
                if (!isAuto) showToast("é æ¸¬å¤±æ•—: " + e.message, "error");
            }
        };

        function getWeatherDesc(code) {
            const map = {
                0: "â˜€ï¸ æ™´æœ—", 1: "ğŸŒ¤ï¸ å¤šé›²æ™‚æ™´", 2: "â˜ï¸ å¤šé›²", 3: "â˜ï¸ é™°å¤©",
                45: "ğŸŒ«ï¸ èµ·éœ§", 51: "ğŸŒ§ï¸ æ¯›æ¯›é›¨", 53: "ğŸŒ§ï¸ å°é›¨", 61: "â˜” å°é›¨", 
                63: "â˜” ä¸­é›¨", 65: "â˜” å¤§é›¨", 80: "ğŸŒ¦ï¸ é›·é™£é›¨", 95: "â›ˆï¸ é›·é›¨"
            };
            return map[code] || "æœªçŸ¥å¤©æ°£";
        }

        // 5. é–‹æ”¤/æ”¶æ”¤åŠŸèƒ½ (ä¿®æ”¹ç‚ºæ”¯æ´å½ˆçª—ç¢ºèª)
        window.startWork = async (isAuto = false) => {
            const btn = document.getElementById('btn-start-work');
            if(btn && !isAuto) btn.disabled = true;

            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);

            if (isAuto) {
                await confirmTimeAdjustment('start', now.toISOString());
                if(btn) btn.disabled = false;
            } else {
                pendingTimeAction = 'start';
                window.openTimeModal('ğŸš€ ç¢ºèªé–‹å§‹ç‡Ÿæ¥­æ™‚é–“', localISOTime);
                if(btn) btn.disabled = false;
            }
        };

        window.endWork = async (isAuto = false) => {
            if (!currentWorkSession) return;
            const btn = document.getElementById('btn-end-work');
            if(btn && !isAuto) btn.disabled = true;

            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);

            if (isAuto) {
                await confirmTimeAdjustment('end', now.toISOString());
                if(btn) btn.disabled = false;
            } else {
                pendingTimeAction = 'end';
                window.openTimeModal('ğŸŒ™ ç¢ºèªçµæŸç‡Ÿæ¥­æ™‚é–“', localISOTime);
                if(btn) btn.disabled = false;
            }
        };

        window.openTimeModal = (title, defaultTime, sessionId = null) => {
            document.getElementById('time-modal-title').innerText = title;
            document.getElementById('time-input').value = defaultTime;
            document.getElementById('time-adjust-modal').classList.remove('hidden');
            pendingSessionId = sessionId;

            // ğŸŸ¢ æ–°å¢ï¼šæ ¹æ“šå‹•ä½œé¡å‹é¡¯ç¤ºæˆ–éš±è—åˆªé™¤æŒ‰éˆ•
            const delBtn = document.getElementById('btn-delete-time');
            if(delBtn) {
                // åªæœ‰åœ¨ã€Œä¿®æ”¹æ­·å²ç´€éŒ„ã€æ™‚æ‰é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
                if (pendingTimeAction === 'edit_start' || pendingTimeAction === 'edit_end') {
                    delBtn.classList.remove('hidden');
                    // å‹•æ…‹æ›´æ›æŒ‰éˆ•æ–‡å­—
                    delBtn.innerText = pendingTimeAction === 'edit_start' ? "ğŸ—‘ï¸ åˆªé™¤æ•´ç­†ç´€éŒ„" : "ğŸ—‘ï¸ æ¸…é™¤æ”¶æ”¤æ™‚é–“";
                } else {
                    delBtn.classList.add('hidden');
                }
            }
        };

        // ğŸŸ¢ æ–°å¢ï¼šåˆªé™¤æ™‚é–“/ç´€éŒ„åŠŸèƒ½
        window.deleteTime = async () => {
            if (!pendingSessionId) return;
            
            const btn = document.getElementById('btn-delete-time');
            btn.disabled = true;
            btn.innerText = "è™•ç†ä¸­...";

            try {
                if (pendingTimeAction === 'edit_start') {
                    if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ç­†ç‡Ÿæ¥­ç´€éŒ„å—ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼")) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'work_sessions', pendingSessionId));
                        showToast("âœ… ç‡Ÿæ¥­ç´€éŒ„å·²åˆªé™¤");
                    }
                } else if (pendingTimeAction === 'edit_end') {
                    if (confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ”¶æ”¤æ™‚é–“å—ï¼Ÿç‹€æ…‹å°‡è®Šå›ã€Œç‡Ÿæ¥­ä¸­ã€ã€‚")) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'work_sessions', pendingSessionId), {
                            endTime: null
                        });
                        showToast("âœ… æ”¶æ”¤æ™‚é–“å·²æ¸…é™¤ï¼Œæ¢å¾©ç‡Ÿæ¥­ä¸­");
                    }
                }
                document.getElementById('time-adjust-modal').classList.add('hidden');
            } catch (e) {
                showToast("åˆªé™¤å¤±æ•—ï¼š" + e.message, "error");
            } finally {
                btn.disabled = false;
            }
        };

        window.confirmTime = async () => {
            const timeVal = document.getElementById('time-input').value;
            if (!timeVal) return showToast("è«‹é¸æ“‡æœ‰æ•ˆæ™‚é–“", "error");
            
            const selectedDate = new Date(timeVal);
            const isoString = selectedDate.toISOString();

            const btn = document.getElementById('btn-confirm-time');
            const originalText = btn.innerText;
            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                await confirmTimeAdjustment(pendingTimeAction, isoString, pendingSessionId);
                document.getElementById('time-adjust-modal').classList.add('hidden');
            } catch(e) {
                showToast("æ“ä½œå¤±æ•—ï¼š" + e.message, "error");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        async function confirmTimeAdjustment(action, timeIsoString, sessionId = null) {
            try {
                if (action === 'start') {
                    const todayStr = toTaiwanDate(timeIsoString); 
                    let weatherSnapshot = {};
                    
                    let todayForecast = forecastHistory.find(f => f.targetDate === todayStr);
                    if (!todayForecast) {
                         const wData = await fetchTainanWeather();
                         const idx = wData.daily.time.indexOf(todayStr);
                         if(idx !== -1) {
                             weatherSnapshot = {
                                desc: wData.daily.weathercode[idx],
                                tempMax: wData.daily.temperature_2m_max[idx],
                                rain: wData.daily.precipitation_probability_max[idx]
                             };
                         }
                    } else {
                        weatherSnapshot = {
                            desc: todayForecast.weather.weatherCode,
                            tempMax: todayForecast.weather.tempMax,
                            rain: todayForecast.weather.rainProb
                        };
                    }

                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'work_sessions'), {
                        startTime: timeIsoString,
                        endTime: null,
                        weatherSnapshot: weatherSnapshot
                    });
                    showToast("ğŸš€ é–‹å§‹ç‡Ÿæ¥­å›‰ï¼åª½åª½åŠ æ²¹ï¼");

                } else if (action === 'end') {
                    const sessionToUpdate = currentWorkSession;
                    if (!sessionToUpdate) throw new Error("ç„¡é€²è¡Œä¸­çš„ç‡Ÿæ¥­ç´€éŒ„");

                    const dayStr = toTaiwanDate(sessionToUpdate.startTime);
                    const todayRecords = records.filter(r => r.date.startsWith(dayStr));
                    let dayRevenue = 0;
                    let dayProfit = 0;
                    todayRecords.forEach(r => {
                        dayRevenue += (r.revenue || 0);
                        dayProfit += (r.profit || 0);
                    });

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'work_sessions', sessionToUpdate.id), {
                        endTime: timeIsoString,
                        finalRevenue: dayRevenue,
                        finalProfit: dayProfit
                    });
                    showToast("ğŸŒ™ çµæŸç‡Ÿæ¥­ï¼åª½åª½è¾›è‹¦äº†ï¼Œæ—©é»ä¼‘æ¯ï¼");

                } else if (action === 'edit_start' && sessionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'work_sessions', sessionId), {
                        startTime: timeIsoString
                    });
                    showToast("âœ… é–‹å§‹æ™‚é–“å·²ä¿®æ­£");

                } else if (action === 'edit_end' && sessionId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'work_sessions', sessionId), {
                        endTime: timeIsoString
                    });
                    showToast("âœ… çµæŸæ™‚é–“å·²ä¿®æ­£");
                }
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        window.editSessionTime = (id, type, currentIso) => {
            pendingTimeAction = type === 'start' ? 'edit_start' : 'edit_end';
            const title = type === 'start' ? 'ä¿®æ”¹é–‹å§‹ç‡Ÿæ¥­æ™‚é–“' : 'ä¿®æ”¹çµæŸç‡Ÿæ¥­æ™‚é–“';
            
            let defaultVal = "";
            if (currentIso) {
                const d = new Date(currentIso);
                const offset = d.getTimezoneOffset() * 60000;
                defaultVal = (new Date(d - offset)).toISOString().slice(0, 16);
            } else {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                defaultVal = (new Date(now - offset)).toISOString().slice(0, 16);
            }

            window.openTimeModal(title, defaultVal, id);
        };

        function renderWorkStatus() {
            const statusBadge = document.getElementById('work-status-badge');
            const actionArea = document.getElementById('work-action-area');
            
            let statusHtml = `<span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold">ğŸ’¤ å°šæœªç‡Ÿæ¥­</span>`;
            let actionBtn = `
                <button id="btn-start-work" onclick="window.startWork()" class="w-full py-5 bg-blue-600 hover:bg-blue-700 text-white font-black text-2xl rounded-2xl shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    ğŸš€ é–‹å§‹ç‡Ÿæ¥­
                </button>`;

            if (todaySession) {
                if (todaySession.endTime) {
                    statusHtml = `<span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold">ğŸŒ™ å·²çµæŸç‡Ÿæ¥­</span>`;
                    actionBtn = `<div class="w-full py-4 bg-gray-100 text-gray-400 font-bold text-center rounded-2xl border-2 border-dashed border-gray-200">ä»Šæ—¥ç‡Ÿæ¥­çµæŸ</div>`;
                } else {
                    statusHtml = `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold animate-pulse">ğŸŸ¢ ç‡Ÿæ¥­ä¸­</span>`;
                    actionBtn = `
                        <button id="btn-end-work" onclick="window.endWork()" class="w-full py-5 bg-red-500 hover:bg-red-600 text-white font-black text-2xl rounded-2xl shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                            ğŸŒ™ çµæŸç‡Ÿæ¥­
                        </button>`;
                }
            }

            if(statusBadge) statusBadge.innerHTML = statusHtml;
            if(actionArea) {
                actionArea.innerHTML = actionBtn;
            }
        }

        // 7. æ¸²æŸ“é æ¸¬ UI
        function renderForecastUI() {
            const todayStr = toTaiwanDate(new Date().toISOString());
            const todayForecast = forecastHistory.find(f => f.targetDate === todayStr);
            const container = document.getElementById('forecast-weather-container');
            
            if (container) {
                container.innerHTML = '';
                const today = new Date();
                for(let i=0; i<7; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    const dStr = toTaiwanDate(d.toISOString());
                    const f = forecastHistory.find(f => f.targetDate === dStr);
                    const isToday = i === 0;

                    // ğŸŸ¢ æ–°å¢ï¼šè¨ˆç®—è¾²æ›†æ—¥æœŸ
                    let lunarStr = "";
                    try {
                        if (typeof Lunar !== 'undefined') {
                            const lDate = Lunar.fromDate(d);
                            lunarStr = lDate.getDayInChinese();
                            // å¦‚æœæ˜¯åˆä¸€ï¼Œé¡¯ç¤ºæœˆä»½æ¯”è¼ƒæ¸…æ¥š (e.g., æ­£æœˆåˆä¸€)
                            if (lDate.getDay() === 1) {
                                lunarStr = lDate.getMonthInChinese() + "æœˆ" + lunarStr;
                            }
                        }
                    } catch(e) {}

                    const div = document.createElement('div');
                    div.className = `flex-shrink-0 w-24 p-3 rounded-2xl border flex flex-col items-center justify-between text-center snap-center ${isToday ? 'bg-indigo-50 border-indigo-300 ring-2 ring-indigo-100' : 'bg-white border-gray-100'}`;
                    
                    if (f) {
                        const w = f.weather;
                        const weatherIcon = getWeatherIcon(w.weatherCode);
                        const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                        const dayName = days[d.getDay()];

                        div.innerHTML = `
                            <div class="mb-1">
                                <p class="text-[10px] text-gray-400 font-bold leading-tight">${dStr.slice(5).replace('-','/')} ${dayName}</p>
                                <p class="text-[10px] text-purple-500 font-medium leading-tight mt-0.5">${lunarStr}</p>
                            </div>
                            <div class="text-2xl mb-1">${weatherIcon}</div>
                            <div class="text-[10px] text-gray-600 font-mono">
                                <span class="text-blue-500">${Math.round(w.tempMin)}Â°</span>/<span class="text-red-500">${Math.round(w.tempMax)}Â°</span>
                            </div>
                            <div class="text-[9px] text-blue-400 mt-1">â˜” ${w.rainProb}%</div>
                        `;
                    } else {
                        div.innerHTML = `<p class="text-[10px] text-gray-300">${dStr.slice(5)}</p><p class="text-xs text-gray-300 mt-2">ç„¡è³‡æ–™</p>`;
                    }
                    container.appendChild(div);
                }
            }

            const aiCardContainer = document.getElementById('ai-forecast-cards');
            if (aiCardContainer) {
                aiCardContainer.innerHTML = '';
                const today = new Date();
                const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

                const forecastOrder = [1, 0];

                for(let i of forecastOrder) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    const dStr = toTaiwanDate(d.toISOString());
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    const dayName = dayNames[d.getDay()];
                    const formattedDate = `${yyyy}/${mm}/${dd} (é€±${dayName})`;

                    const f = forecastHistory.find(f => f.targetDate === dStr);
                    
                    if (f && f.aiPrediction) {
                        const ai = f.aiPrediction;
                        let titlePrefix = "";
                        let bgClass = "";
                        let textClass = "";
                        let moodColor = "";

                        if (i === 1) {
                            titlePrefix = "â­ æ˜æ—¥é å ± (é‡é»)";
                            bgClass = "from-indigo-600 to-blue-500 text-white shadow-xl ring-4 ring-blue-50 border-2 border-blue-400";
                            textClass = "text-indigo-100";
                            moodColor = ai.buyingMood === 'é«˜' ? 'text-yellow-300' : 'text-white';
                        } else {
                            titlePrefix = "æœ¬æ—¥é å ±";
                            bgClass = "from-gray-50 to-white text-gray-600 border border-gray-200";
                            textClass = "text-gray-500";
                            moodColor = ai.buyingMood === 'é«˜' ? 'text-red-500' : 'text-gray-800';
                        }
                        
                        const btnId = `btn-refresh-${dStr}`;
                        const btnClass = i === 1 
                            ? "text-xs bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg transition backdrop-blur-sm font-bold flex items-center gap-1 ring-1 ring-white/30"
                            : "text-xs bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 py-1.5 rounded-lg transition font-bold flex items-center gap-1";

                        const uvIdx = f.weather.uvIndex || 0;
                        let uvClass = "bg-gray-100 text-gray-500";
                        if(uvIdx >= 6) uvClass = "bg-orange-100 text-orange-600 font-bold";
                        if(uvIdx >= 8) uvClass = "bg-red-100 text-red-600 font-black animate-pulse";

                        const tempMinClass = i === 1 ? 'border-white/30 bg-white/10' : 'border-blue-200 bg-blue-50 text-blue-700';
                        const tempMaxClass = i === 1 ? 'border-white/30 bg-white/10' : 'border-orange-200 bg-orange-50 text-orange-700';

                        const card = document.createElement('div');
                        card.className = `bg-gradient-to-br ${bgClass} rounded-3xl p-5 transform transition hover:scale-[1.01] mb-4 relative overflow-hidden`;
                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-3 border-b ${i===1?'border-white/20':'border-gray-200'} pb-2">
                                <div class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-3">
                                    <h3 class="font-bold text-xl flex items-center gap-2">${titlePrefix}</h3>
                                    <span class="text-sm opacity-80 font-mono tracking-wide font-medium">${formattedDate}</span>
                                </div>
                                <button id="${btnId}" onclick="window.retryForecast('${dStr}', '${btnId}')" class="${btnClass}">
                                    ğŸ”„ é‡æ–°é å ±
                                </button>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <p class="${textClass} text-xs font-bold mb-2 flex flex-wrap items-center gap-2">
                                        <span class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded shadow-sm border border-blue-200">ğŸ“ å°å—å¸‚</span>
                                        <span>${getWeatherDesc(f.weather.weatherCode)}</span>
                                        <span>ğŸ’§ ${f.weather.rainProb}%</span>
                                        <span class="px-1.5 py-0.5 rounded text-[10px] border ${tempMinClass}">ğŸŒ™æ¸…æ™¨ ${Math.round(f.weather.tempMin)}Â°</span>
                                        <span class="px-1.5 py-0.5 rounded text-[10px] border ${tempMaxClass}">â˜€ï¸ç™½å¤© ${Math.round(f.weather.tempMax)}Â°</span>
                                        
                                        <span class="bg-black/10 px-1.5 py-0.5 rounded text-[10px]">${f.weather.windLevel}</span>
                                        <span class="${uvClass} px-1.5 py-0.5 rounded text-[10px] shadow-sm">â˜€ï¸ UV ${uvIdx}</span>
                                    </p>
                                    <div class="flex items-baseline gap-2 mb-3">
                                        <span class="text-4xl font-black ${moodColor}">è²·æ°£ï¼š${ai.buyingMood}</span>
                                    </div>
                                    <p class="text-sm opacity-95 leading-relaxed text-justify font-medium">ğŸ‘¦ ${ai.moodReason}</p>
                                </div>
                                <div class="${i===1 ? 'bg-white/10 border-white/20 text-white' : 'bg-gray-100 border-gray-200 text-gray-600'} border rounded-2xl p-3 min-w-[120px] backdrop-blur-sm">
                                    <p class="text-[10px] opacity-70 mb-1 font-bold uppercase tracking-wider">âœ¨ å…’å­æ¨è–¦ä¸»æ‰“</p>
                                    <ul class="text-sm font-bold space-y-1 list-none">
                                        ${ai.recommendedFruits.slice(0,5).map(fruit => {
                                            const emoji = getFruitEmoji(fruit);
                                            return `<li>${emoji} ${fruit}</li>`;
                                        }).join('')}
                                    </ul>
                                </div>
                            </div>
                        `;
                        aiCardContainer.appendChild(card);
                    }
                }
            }
        }
        
        function getFruitEmoji(name) {
            if (!name) return 'ğŸ';
            const n = name.toLowerCase();
            if (n.includes('é³³æ¢¨')) return 'ğŸ';
            if (n.includes('é¦™è•‰')) return 'ğŸŒ';
            if (n.includes('è˜‹æœ')) return 'ğŸ';
            if (n.includes('æ©˜') || n.includes('æŸ‘') || n.includes('æ©™')) return 'ğŸŠ';
            if (n.includes('è¥¿ç“œ')) return 'ğŸ‰';
            if (n.includes('èŠ’æœ')) return 'ğŸ¥­';
            if (n.includes('è‰è“')) return 'ğŸ“';
            if (n.includes('è‘¡è„')) return 'ğŸ‡';
            if (n.includes('æ¢¨')) return 'ğŸ';
            if (n.includes('æ¡ƒ')) return 'ğŸ‘';
            if (n.includes('æª¸æª¬')) return 'ğŸ‹';
            if (n.includes('ç•ªèŒ„') || n.includes('è•ƒèŒ„')) return 'ğŸ…';
            if (n.includes('å¥‡ç•°æœ')) return 'ğŸ¥';
            if (n.includes('æ¤°å­')) return 'ğŸ¥¥';
            if (n.includes('æ«»æ¡ƒ')) return 'ğŸ’';
            if (n.includes('å“ˆå¯†ç“œ') || n.includes('ç“œ')) return 'ğŸˆ';
            if (n.includes('é‡‹è¿¦')) return 'ğŸŸ¢';
            if (n.includes('è“®éœ§')) return 'ğŸ”´';
            if (n.includes('ç«é¾æœ')) return 'ğŸŸ£';
            return 'ğŸ';
        }

        function getWeatherIcon(code) {
             const map = {
                0: "â˜€ï¸", 1: "ğŸŒ¤ï¸", 2: "â˜ï¸", 3: "â˜ï¸",
                45: "ğŸŒ«ï¸", 51: "ğŸŒ§ï¸", 53: "ğŸŒ§ï¸", 61: "â˜”", 
                63: "â˜”", 65: "â˜”", 80: "ğŸŒ¦ï¸", 95: "â›ˆï¸"
            };
            return map[code] || "â“";
        }

        function updateWorkStatsFilterOptions() {
            const yearSet = new Set(), monthSet = new Set();
            const allDates = new Set();
            
            records.forEach(r => allDates.add(r.date.split('T')[0]));
            workSessions.forEach(w => allDates.add(toTaiwanDate(w.startTime)));

            allDates.forEach(dateStr => {
                const parts = dateStr.split('-');
                if(parts.length >= 2) { yearSet.add(parts[0]); monthSet.add(`${parts[0]}-${parts[1]}`); }
            });

            const sortedYears = Array.from(yearSet).sort().reverse();
            const sortedMonths = Array.from(monthSet).sort().reverse();
            let optionsHtml = '<option value="current_month">ğŸ“… æœ¬æœˆ</option><option value="last_month">ğŸ—“ï¸ ä¸Šå€‹æœˆ</option>';
            sortedYears.forEach(y => { optionsHtml += `<option value="${y}" class="font-bold text-blue-700">ğŸ—“ï¸ ${y}å¹´ (å…¨å¹´)</option>`; });
            sortedMonths.forEach(m => { const [y, mon] = m.split('-'); optionsHtml += `<option value="${m}">${y}å¹´ ${mon}æœˆ</option>`; });
            
            const el = document.getElementById('work-stats-filter');
            if(el && el.innerHTML.indexOf('value="current_month"') === -1) { 
                 el.innerHTML = optionsHtml;
                 const now = new Date();
                 const currentMonthVal = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                 if(sortedMonths.includes(currentMonthVal)) el.value = currentMonthVal;
            }
        }

        window.renderWorkStatsTable = () => {
            const filterVal = document.getElementById('work-stats-filter').value;
            const tbody = document.getElementById('work-stats-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            let targetPrefix = "";
            const now = new Date();
            if (filterVal === 'current_month') targetPrefix = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            else if (filterVal === 'last_month') {
                const lastMonth = new Date(now.getFullYear(), now.getMonth()-1, 1);
                targetPrefix = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth()+1).padStart(2,'0')}`;
            } else {
                targetPrefix = filterVal;
            }

            const relevantDates = new Set();
            
            workSessions.forEach(w => { 
                const twDate = toTaiwanDate(w.startTime);
                if(twDate.startsWith(targetPrefix)) relevantDates.add(twDate); 
            });
            records.forEach(r => { 
                let rDate = r.date;
                if(rDate.includes('T')) rDate = rDate.split('T')[0];
                if(rDate.startsWith(targetPrefix)) relevantDates.add(rDate); 
            });
            forecastHistory.forEach(f => { if(f.targetDate.startsWith(targetPrefix)) relevantDates.add(f.targetDate); });

            const sortedDates = Array.from(relevantDates).sort().reverse();

            let totalRev = 0, totalProf = 0, totalHours = 0, workDays = 0, totalSplit = 0; // ğŸŸ¢ æ–°å¢ï¼šç¸½åˆ†æ½¤è®Šæ•¸

            sortedDates.forEach(dateStr => {
                const session = workSessions.find(w => toTaiwanDate(w.startTime) === dateStr);
                const dayRecords = records.filter(r => r.date.startsWith(dateStr));
                const forecast = forecastHistory.find(f => f.targetDate === dateStr);

                let dRev = 0, dProf = 0, dMarket = "æœªè¨˜éŒ„";
                dayRecords.forEach(r => { dRev += (r.revenue||0); dProf += (r.profit||0); if(r.market) dMarket = r.market; });

                let startT = "-", endT = "-", duration = 0, durationStr = "-";
                let startEditBtn = "", endEditBtn = "";

                if (session) {
                    const sTime = new Date(session.startTime);
                    startT = sTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    startEditBtn = `<button onclick="window.editSessionTime('${session.id}', 'start', '${session.startTime}')" class="text-blue-400 hover:text-blue-600 text-xs ml-1">âœ</button>`;

                    if (session.endTime) {
                        const eTime = new Date(session.endTime);
                        endT = eTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        duration = (eTime - sTime) / (1000 * 60 * 60);
                        durationStr = duration.toFixed(1) + "hr";
                        totalHours += duration;
                        workDays++; 
                        endEditBtn = `<button onclick="window.editSessionTime('${session.id}', 'end', '${session.endTime}')" class="text-blue-400 hover:text-blue-600 text-xs ml-1">âœ</button>`;
                    } else {
                        endT = "ç‡Ÿæ¥­ä¸­";
                        duration = (new Date() - sTime) / (1000 * 60 * 60);
                        durationStr = duration.toFixed(1) + "hr (è¨ˆæ™‚ä¸­)";
                        endEditBtn = `<button onclick="window.editSessionTime('${session.id}', 'end', '')" class="text-blue-400 hover:text-blue-600 text-xs ml-1">âœ</button>`;
                    }
                }

                totalRev += dRev;
                totalProf += dProf;

                const split = Math.round(dProf * 0.5);
                totalSplit += split; // ğŸŸ¢ æ–°å¢ï¼šç´¯åŠ åˆ†æ½¤
                const predMood = forecast && forecast.aiPrediction ? forecast.aiPrediction.buyingMood : "-";
                
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-gray-50 text-sm";
                tr.innerHTML = `
                    <td class="p-3 font-bold text-gray-700">${dateStr.slice(5)}</td>
                    <td class="p-3 text-gray-500 whitespace-nowrap">${startT}${startEditBtn}</td>
                    <td class="p-3 text-gray-500 whitespace-nowrap">${endT}${endEditBtn}</td>
                    <td class="p-3 font-mono text-blue-600">${durationStr}</td>
                    <td class="p-3 text-right font-bold text-gray-800">$${dRev.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold ${dProf >= 0 ? 'text-green-600' : 'text-red-600'}">$${dProf.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold text-orange-500">$${split.toLocaleString()}</td>
                    <td class="p-3 text-center">${predMood}</td>
                    <td class="p-3 text-center text-gray-600 text-xs">${dMarket}</td>
                `;
                tbody.appendChild(tr);
            });

            const avgHours = workDays > 0 ? (totalHours / workDays).toFixed(1) : 0;
            document.getElementById('stats-avg-hours').innerText = avgHours + " hr";
            document.getElementById('stats-sum-revenue').innerText = "$" + totalRev.toLocaleString();
            document.getElementById('stats-sum-profit').innerText = "$" + totalProf.toLocaleString();
            document.getElementById('stats-sum-split').innerText = "$" + totalSplit.toLocaleString(); // ğŸŸ¢ æ–°å¢ï¼šé¡¯ç¤ºç¸½åˆ†æ½¤
        }

        // ... existing functions (analyzeImage, runAiAnalysis, saveAiAnalysis, etc.) ...
        // (Keeping all previously defined functions)
        window.analyzeImage = async (base64Data) => {
            myApiKey = localStorage.getItem('user_gemini_api_key') || "";
            if (!myApiKey) {
                showToast("âš ï¸ è«‹å…ˆè¨­å®š API Keyï¼", "error");
                window.openSettings(); 
                return null;
            }
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.querySelector('p').innerText = "AI å…’å­æ­£åœ¨å¹«å¿™è®€å–å¸³å–®...";
            loadingOverlay.classList.remove('hidden');
            const currentYear = new Date().getFullYear();
            let mappingPrompt = "";
            if (itemMappings.length > 0) {
                const mapList = itemMappings.map(m => `"${m.alias}" -> "${m.standardName}"`).join(", ");
                mappingPrompt = `ã€å“é …æ ¡æ­£ã€‘è«‹åƒè€ƒå°ç…§è¡¨ï¼š${mapList}ã€‚`;
            }
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¨˜å¸³åŠ©ç†ã€‚è«‹åˆ†æé€™å¼µåœ–ç‰‡ã€‚é€™é€šå¸¸æ˜¯ä¸€å¼µåŒ…å«ã€Œé€²è²¨/æˆæœ¬æ˜ç´°ã€çš„å–®æ“šï¼Œä¸”åœ–ç‰‡æŸè™•å¯èƒ½å¯«æœ‰ç•¶æ—¥çš„ã€Œç¸½ç‡Ÿæ¥­é¡ã€ã€‚
            ${mappingPrompt}
            è«‹å›å‚³ JSON æ ¼å¼è³‡æ–™ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
            1. date (å­—ä¸²): æ—¥æœŸ YYYY-MM-DDã€‚è‹¥åªæœ‰æœˆæ—¥ï¼Œè£œä¸Šå¹´ä»½ ${currentYear}ã€‚
            2. revenue (æ•¸å­—): ç•¶æ—¥ç¸½ç‡Ÿæ¥­é¡ã€‚
            3. items (é™£åˆ—): æˆæœ¬/é€²è²¨æ¸…å–® (name, qty, unitPrice, cost, note)ã€‚
            è«‹åªå›å‚³ JSON å­—ä¸²ã€‚`;
            try {
                const result = await callGeminiAPI(prompt, base64Data);
                return JSON.parse(result.replace(/```json|```/gi, "").trim());
            } catch (e) {
                showToast(`è¾¨è­˜å¤±æ•—ï¼š${e.message}`, "error");
                return null;
            }
        };

        window.runAiAnalysis = async () => {
            const filterSelect = document.getElementById('ai-filter');
            const filterVal = filterSelect.value;
            const filterText = filterSelect.options[filterSelect.selectedIndex].text;
            let targetRecords = records;
            if (filterVal !== 'all') targetRecords = records.filter(r => r.date.startsWith(filterVal));
            if (targetRecords.length === 0) return showToast("è©²æœŸé–“ç„¡è³‡æ–™", "error");
            const btnAnalyze = document.getElementById('btn-analyze');
            const originalText = btnAnalyze.innerHTML;
            btnAnalyze.innerHTML = "â³ å…’å­æ€è€ƒä¸­...";
            btnAnalyze.disabled = true;
            let totalRev = 0, totalCost = 0, totalProfit = 0;
            const itemMap = {};
            const feedbacks = [];
            targetRecords.forEach(r => {
                totalRev += r.revenue || 0;
                totalCost += r.totalCost || 0;
                totalProfit += r.profit || 0;
                r.items.forEach(i => {
                    if(!itemMap[i.name]) itemMap[i.name] = { qty: 0, cost: 0, notes: [] };
                    itemMap[i.name].qty += (i.qty || 0);
                    itemMap[i.name].cost += (i.cost || 0);
                    if(i.note) feedbacks.push(`${i.name}: ${i.note}`);
                });
            });
            const topCostItems = Object.entries(itemMap).sort(([,a], [,b]) => b.cost - a.cost).slice(0, 5).map(([n, v]) => `${n}($${v.cost})`).join('; ');
            const prompt = `ä½ æ˜¯æ°´æœæ”¤è€é—†å¨˜çš„è²¼å¿ƒå…’å­ï¼Œæ­£åœ¨å¹«åª½åª½åˆ†æç”Ÿæ„æ•¸æ“šã€‚è«‹æ ¹æ“šä»¥ä¸‹æ•¸æ“šé€²è¡Œã€${filterText}ã€‘çš„è¨ºæ–·ã€‚
            ç‡Ÿæ”¶:$${totalRev}, æˆæœ¬:$${totalCost}, åˆ©æ½¤:$${totalProfit}ã€‚ä¸»è¦æˆæœ¬:${topCostItems}ã€‚åé¥‹:${feedbacks.slice(0,3).join(';') || 'ç„¡'}ã€‚
            è«‹æä¾›: 1.ç²åˆ©èƒ½åŠ›åˆ†æ 2.æˆæœ¬æ§åˆ¶å»ºè­° 3.ç‡Ÿé‹å„ªåŒ–ç­–ç•¥ 4.é¡§å®¢å›é¥‹æ´å¯Ÿ 5.æš–å¿ƒé¼“å‹µ(çµ¦åª½åª½çš„è©±)ã€‚è«‹ç”¨Markdownï¼Œèªæ°£è¦å­é †ã€æº«æš–ã€‚`;
            try {
                const result = await callGeminiAPI(prompt, null);
                const resultContainer = document.getElementById('ai-result-content');
                resultContainer.innerHTML = marked.parse(result);
                document.getElementById('ai-result-box').classList.remove('hidden');
                currentAnalysisResult = result;
                document.getElementById('btn-save-analysis').classList.remove('hidden');
            } catch (e) { showToast(`åˆ†æå¤±æ•—ï¼š${e.message}`, "error"); } 
            finally { 
                btnAnalyze.innerHTML = originalText;
                btnAnalyze.disabled = false;
            }
        };

        window.saveAiAnalysis = async () => {
            if (!currentAnalysisResult) return;
            const filterVal = document.getElementById('ai-filter').value;
            const filterText = document.getElementById('ai-filter').options[document.getElementById('ai-filter').selectedIndex].text;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'analyses'), {
                    date: new Date().toISOString(), period: filterVal, periodName: filterText, content: currentAnalysisResult
                });
                showToast("âœ… åˆ†æå ±å‘Šå·²å­˜æª”ï¼");
            } catch (e) { showToast("å­˜æª”å¤±æ•—", "error"); }
        };

        window.exportAiAnalysis = () => {
            if (!currentAnalysisResult) return showToast("è«‹å…ˆåŸ·è¡Œåˆ†æ", "error");
            const textContent = currentAnalysisResult.replace(/[#*`]/g, '');
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([["AI ç‡Ÿé‹åˆ†æå ±å‘Š"], [new Date().toLocaleString()], [textContent]]);
            XLSX.utils.book_append_sheet(wb, ws, "AIåˆ†æ");
            XLSX.writeFile(wb, `AIåˆ†æå ±å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        window.sendChatMessage = async () => {
            const inputEl = document.getElementById('chat-input');
            const message = inputEl.value.trim();
            if (!message) return;
            window.appendChatMessage('user', message);
            inputEl.value = '';
            chatHistory.push({ role: 'user', text: message });
            const relevantRecords = [...records].sort((a,b) => new Date(a.date) - new Date(b.date)).slice(-365);
            let dataContext = "Date,Revenue,Profit,Note\n";
            relevantRecords.forEach(r => {
                const noteSummary = r.items.map(i => i.name).join(';').substring(0, 50); 
                dataContext += `${r.date.split('T')[0]},${r.revenue},${r.profit},${noteSummary}\n`;
            });
            const contextInfo = `
            ã€ä½ æ˜¯æ°´æœæ”¤è€é—†å¨˜çš„è²¼å¿ƒå…’å­ï¼Œæ­£åœ¨å¹«åª½åª½çœ‹é¡§ç”Ÿæ„ã€‘
            é€™æ˜¯è¿‘æœŸæ¯æ—¥ç‡Ÿé‹æ•¸æ“š (CSVæ ¼å¼):
            ${dataContext}
            è«‹æ ¹æ“šä»¥ä¸Šæ•¸æ“šå›ç­”åª½åª½çš„å•é¡Œã€‚
            æ³¨æ„ï¼š
            1. åª½åª½å¯èƒ½å•ã€Œä¸Šå€‹æœˆã€ã€ã€Œä¸€æœˆã€ã€ã€Œç¦®æ‹œä¸‰ã€ç­‰ï¼Œè«‹ä½ è‡ªå·±è¨ˆç®—åŠ ç¸½æˆ–å¹³å‡ã€‚
            2. ä¸è¦æ­»æ¿åœ°åªå›ç­”æ•¸å­—ï¼Œèªæ°£è¦å­é †ã€æº«æš–ã€å¤šçµ¦åª½åª½é¼“å‹µã€‚
            `;
            let fullPrompt = `${contextInfo}\n\n`;
            const recentHistory = chatHistory.slice(-6); 
            recentHistory.forEach(msg => {
                fullPrompt += `${msg.role === 'user' ? 'åª½åª½' : 'å…’å­'}: ${msg.text}\n`;
            });
            fullPrompt += `åª½åª½: ${message}\nå…’å­:`;
            const loadingId = window.appendChatMessage('loading', 'å…’å­æ­£åœ¨æ€è€ƒ...');
            try {
                const responseText = await callGeminiAPI(fullPrompt, null);
                document.getElementById(loadingId).remove();
                window.appendChatMessage('model', responseText);
                chatHistory.push({ role: 'model', text: responseText });
            } catch (e) {
                document.getElementById(loadingId).remove();
                window.appendChatMessage('error', 'ç¶²è·¯æœ‰é»å¡ï¼Œç­‰ä¸€ä¸‹å†è©¦è©¦å–”åª½åª½ã€‚');
            }
        };

        window.appendChatMessage = (role, text) => {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now();
            div.id = id;
            div.className = `flex w-full mb-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            let innerHTML = '';
            if (role === 'user') {
                innerHTML = `<div class="bg-indigo-600 text-white px-5 py-3 rounded-2xl rounded-tr-none max-w-[85%] shadow-md text-base leading-relaxed">${text}</div>`;
            } else if (role === 'model') {
                innerHTML = `<div class="bg-white border border-gray-200 text-gray-800 px-5 py-4 rounded-2xl rounded-tl-none max-w-[95%] shadow-sm text-base leading-relaxed prose prose-sm">${marked.parse(text)}</div>`;
            } else if (role === 'loading') {
                innerHTML = `<div class="bg-gray-100 text-gray-500 px-4 py-2 rounded-2xl rounded-tl-none text-xs animate-pulse flex items-center gap-2"><span>ğŸ”®</span> ${text}</div>`;
            } else {
                innerHTML = `<div class="bg-red-100 text-red-600 px-4 py-2 rounded-2xl text-xs">âŒ ${text}</div>`;
            }
            div.innerHTML = innerHTML;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        };

        window.saveChatSession = async () => {
            if (chatHistory.length === 0) return showToast("æ²’æœ‰å°è©±ç´€éŒ„å¯å­˜", "error");
            const btn = document.getElementById('btn-save-chat');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ å„²å­˜ä¸­...";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_sessions'), {
                    date: new Date().toISOString(),
                    messages: chatHistory
                });
                showToast("âœ… å°è©±ç´€éŒ„å·²å„²å­˜è‡³é›²ç«¯ï¼");
            } catch (e) { showToast("å„²å­˜å¤±æ•—", "error"); }
            finally { btn.innerHTML = originalText; }
        };

        window.downloadChatExcel = () => {
            if (chatHistory.length === 0) return showToast("æ²’æœ‰å°è©±ç´€éŒ„å¯ä¸‹è¼‰", "error");
            const data = chatHistory.map(msg => ({
                "è§’è‰²": msg.role === 'user' ? 'åª½åª½' : 'è²¼å¿ƒå…’å­',
                "å…§å®¹": msg.text,
                "æ™‚é–“": new Date().toLocaleString()
            }));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            ws['!cols'] = [{ wch: 10 }, { wch: 80 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, "AIå°è©±ç´€éŒ„");
            XLSX.writeFile(wb, `AIå°è©±ç´€éŒ„_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        async function callGeminiAPI(prompt, base64Image) {
            myApiKey = localStorage.getItem('user_gemini_api_key') || "";
            if (!myApiKey) throw new Error("âš ï¸ API Key æœªè¨­å®š");
            let modelName = "models/gemini-1.5-flash";
            try {
                const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${myApiKey}`);
                if (listResp.ok) {
                    const listData = await listResp.json();
                    const validModel = listData.models?.find(m => m.name.includes("gemini") && m.supportedGenerationMethods.includes("generateContent"));
                    if (validModel) modelName = validModel.name;
                } else {
                     if (listResp.status === 429) throw new Error("âš ï¸ é¡åº¦å·²æ»¿ (429)ï¼šè«‹ç¨å¾Œå†è©¦ï¼Œæˆ–æ›´æ› API Key");
                     if (listResp.status === 400 || listResp.status === 403) throw new Error("âš ï¸ Key ç„¡æ•ˆæˆ–ç„¡æ¬Šé™ï¼šè«‹æª¢æŸ¥è¨­å®š");
                }
            } catch(e) { throw e; }
            const parts = [{ text: prompt }];
            if (base64Image) parts.push({ inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } });
            const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${myApiKey}`;
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts }] }) });
            if (!response.ok) {
                if (response.status === 429) throw new Error("âš ï¸ é¡åº¦å·²æ»¿ (429)ï¼šGoogle èªªæ‚¨ç´¯äº†ï¼Œè«‹ä¼‘æ¯ä¸€ä¸‹å†è©¦ï¼");
                if (response.status === 400 || response.status === 403) throw new Error("âš ï¸ Key ç„¡æ•ˆ (400)ï¼šè«‹æª¢æŸ¥è¨­å®š");
                const err = await response.json();
                throw new Error(err.error?.message || "API é€£ç·šéŒ¯èª¤");
            }
            const json = await response.json();
            return json.candidates?.[0]?.content?.parts?.[0]?.text || "";
        }

        // ... existing UI logic ...
        window.handleFileUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64 = event.target.result;
                document.getElementById('img-preview').src = base64;
                document.getElementById('preview-box').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
                try {
                    const data = await window.analyzeImage(base64);
                    fillEditor(data || { revenue: 0, items: [], date: "" }, base64);
                } catch (err) { fillEditor({ revenue: 0, items: [], date: "" }, base64); } 
                finally { document.getElementById('loading-overlay').classList.add('hidden'); }
            };
            reader.readAsDataURL(file);
        };

        function fillEditor(data, base64) {
            document.getElementById('edit-revenue').value = data.revenue || 0;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('edit-date').value = data.date ? data.date : today;
            const tbody = document.getElementById('edit-items-body');
            tbody.innerHTML = '';
            (data.items?.length ? data.items : [{name:'', qty:1, unitPrice:0, cost:0}]).forEach(i => window.addItemRow(i.name, i.qty, i.unitPrice, i.note || ""));
            window.tempImage = base64;
            document.getElementById('editor-view').classList.remove('hidden');
            window.recalc();
        }

        window.addItemRow = (name = '', qty = 1, unitPrice = 0, note = '') => {
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-50 align-top";
            tr.innerHTML = `
                <td class="py-2 px-1"><input type="text" value="${name}" class="w-full border rounded p-2 item-name text-sm min-w-[120px]" placeholder="å“é …(æˆæœ¬)"></td>
                <td class="py-2 px-1"><input type="number" value="${qty}" class="w-full border rounded p-2 item-qty text-center text-sm min-w-[60px]" oninput="window.rowUpdate(this)"></td>
                <td class="py-2 px-1"><input type="number" value="${unitPrice}" class="w-full border rounded p-2 item-uprice text-right text-sm min-w-[80px]" placeholder="å–®åƒ¹" oninput="window.rowUpdate(this)"></td>
                <td class="py-2 px-1"><input type="number" value="${qty * unitPrice}" class="w-full border rounded p-2 item-subtotal text-right text-sm bg-gray-50 font-bold min-w-[80px]" readonly></td>
                <td class="py-2 px-1"><input type="text" value="${note}" class="w-full border rounded p-2 item-note text-sm text-purple-700 bg-purple-50 placeholder-purple-200 min-w-[150px]" placeholder="å‚™è¨»/å®¢äººåæ‡‰"></td>
                <td class="py-2 px-1 text-center"><button onclick="this.parentElement.parentElement.remove(); window.recalc()" class="text-red-400 font-bold p-2">âœ•</button></td>
            `;
            document.getElementById('edit-items-body').appendChild(tr);
            window.recalc();
        };

        window.rowUpdate = (input) => {
            const tr = input.parentElement.parentElement;
            const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
            const uprice = parseFloat(tr.querySelector('.item-uprice').value) || 0;
            tr.querySelector('.item-subtotal').value = Math.round(qty * uprice);
            window.recalc();
        };

        window.recalc = () => {
            let totalCost = 0;
            const errors = [];
            document.querySelectorAll('#edit-items-body tr').forEach((tr, index) => {
                const name = tr.querySelector('.item-name').value || `ç¬¬ ${index+1} é …`;
                const qty = parseFloat(tr.querySelector('.item-qty').value) || 0;
                const uprice = parseFloat(tr.querySelector('.item-uprice').value) || 0;
                const subtotal = parseFloat(tr.querySelector('.item-subtotal').value) || 0;
                const calcSub = Math.round(qty * uprice);
                if (Math.abs(calcSub - subtotal) > 1) errors.push(`âš ï¸ [${name}] è¨ˆç®—æœ‰èª¤ï¼š${qty} x ${uprice} æ‡‰ç‚º ${calcSub}`);
                totalCost += subtotal;
            });
            const errorBox = document.getElementById('validation-error-box');
            if (errors.length > 0) {
                errorBox.innerHTML = errors.map(e => `<div class="text-red-600 text-xs py-1">${e}</div>`).join('');
                errorBox.classList.remove('hidden');
            } else {
                errorBox.classList.add('hidden');
                errorBox.innerHTML = '';
            }
            const revenue = parseFloat(document.getElementById('edit-revenue').value) || 0;
            document.getElementById('calc-cost').innerText = totalCost.toLocaleString();
            const profit = revenue - totalCost;
            const profitEl = document.getElementById('calc-profit');
            profitEl.innerText = profit.toLocaleString();
            if (profit < 0) { profitEl.className = "font-black text-orange-600 text-sm"; } else { profitEl.className = "font-black text-green-700 text-sm"; }
            document.getElementById('calc-split').innerText = Math.max(0, profit * 0.5).toLocaleString();
        };

        window.submitRecord = async () => {
            if (!currentUser && !confirm("âš ï¸ æœªé€£ç·šè‡³é›²ç«¯ï¼Œåƒ…æœ¬åœ°æ“ä½œã€‚ç¹¼çºŒï¼Ÿ")) return;
            const selectedDate = document.getElementById('edit-date').value; 
            if (!selectedDate) return showToast("è«‹ç¢ºèªæ—¥æœŸï¼", "error");
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.querySelector('p').innerText = "â˜ï¸ è³‡æ–™ä¸Šå‚³å­˜æª”ä¸­...";
            loadingOverlay.classList.remove('hidden');
            const items = [];
            let totalCost = 0;
            document.querySelectorAll('#edit-items-body tr').forEach(tr => {
                const name = tr.querySelector('.item-name').value;
                const qty = parseInt(tr.querySelector('.item-qty').value) || 0;
                const unitPrice = parseFloat(tr.querySelector('.item-uprice').value) || 0;
                const note = tr.querySelector('.item-note').value;
                if(name) { 
                    const subtotal = qty * unitPrice;
                    totalCost += subtotal;
                    items.push({ name, qty, unitPrice, cost: subtotal, note }); 
                }
            });
            const revenue = parseFloat(document.getElementById('edit-revenue').value) || 0;
            const profit = revenue - totalCost;
            const record = { revenue, totalCost, profit, split: profit * 0.5, items, market: document.getElementById('diary-market').value, mood: document.getElementById('diary-mood').value, date: selectedDate };
            try {
                if (currentEditId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', currentEditId), record);
                    showToast("âœ… ä¿®æ”¹æˆåŠŸï¼");
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), record);
                    showToast("âœ… æ–°å¢æˆåŠŸï¼");
                }
                window.resetEditor();
                loadingOverlay.classList.add('hidden'); 
            } catch (e) { showToast("å„²å­˜å¤±æ•—ï¼š" + e.message, "error"); loadingOverlay.classList.add('hidden'); }
        };

        window.resetEditor = () => {
            currentEditId = null;
            window.tempImage = null;
            document.getElementById('edit-mode-label').classList.add('hidden');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-delete-record').classList.add('hidden'); 
            document.getElementById('btn-submit').innerText = "å„²å­˜";
            document.getElementById('btn-submit').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('btn-submit').classList.add('bg-blue-600');
            document.getElementById('validation-error-box').classList.add('hidden');
            document.getElementById('edit-revenue').value = 0;
            document.getElementById('edit-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('diary-market').selectedIndex = 0;
            document.getElementById('diary-mood').value = "";
            document.getElementById('edit-items-body').innerHTML = "";
            window.addItemRow();
            document.getElementById('img-preview').src = "";
            document.getElementById('preview-box').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            window.recalc();
        };

        window.openMappingModal = () => { document.getElementById('mapping-modal').classList.remove('hidden'); renderMappingList(); };
        window.addMapping = async () => {
            const alias = document.getElementById('mapping-alias').value.trim();
            const standard = document.getElementById('mapping-standard').value.trim();
            if(!alias || !standard) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š", "error");
            const btn = document.getElementById('btn-add-mapping');
            const originalText = btn.innerText;
            btn.innerText = "â³";
            btn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'item_mappings'), { alias, standardName: standard });
                document.getElementById('mapping-alias').value = "";
                document.getElementById('mapping-standard').value = "";
                showToast("âœ… å·²åŒæ­¥è‡³é›²ç«¯");
            } catch(e) { showToast("æ–°å¢å¤±æ•—", "error"); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        };
        window.deleteMapping = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¦å‰‡ï¼Ÿ")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'item_mappings', id));
                showToast("å·²åˆªé™¤");
            }
        };
        window.renderMappingList = () => {
            const tbody = document.getElementById('mapping-tbody');
            tbody.innerHTML = itemMappings.map(m => `<tr class="border-b"><td class="p-2 text-gray-600">${m.alias}</td><td class="p-2 font-bold text-blue-600">âœ</td><td class="p-2 font-bold text-gray-800">${m.standardName}</td><td class="p-2 text-right"><button onclick="window.deleteMapping('${m.id}')" class="text-red-400 hover:text-red-600 font-bold">âœ•</button></td></tr>`).join('');
        };

        window.deleteCurrentRecord = () => {
            if (currentEditId) {
                pendingDeleteId = currentEditId;
                document.getElementById('delete-modal').classList.remove('hidden');
            }
        };
        window.performDelete = async () => {
            if (!pendingDeleteId) return;
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.querySelector('p').innerText = "ğŸ—‘ï¸ æ­£åœ¨åˆªé™¤...";
            loadingOverlay.classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('hidden');
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', pendingDeleteId));
                showToast("âœ… å·²åˆªé™¤");
                window.resetEditor(); 
            } catch (e) { showToast("âŒ åˆªé™¤å¤±æ•—ï¼š" + e.message, "error"); } 
            finally { loadingOverlay.classList.add('hidden'); pendingDeleteId = null; }
        };
        window.confirmDelete = (id) => {
            pendingDeleteId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        window.editRecord = (id) => {
            const r = records.find(rec => rec.id === id);
            if (!r) return;
            currentEditId = id; 
            document.getElementById('edit-mode-label').classList.remove('hidden');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-delete-record').classList.remove('hidden');
            document.getElementById('btn-submit').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('btn-submit').classList.remove('bg-blue-600');
            document.getElementById('btn-submit').classList.add('bg-green-600', 'hover:bg-green-700');
            document.getElementById('img-preview').src = "";
            document.getElementById('preview-box').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('edit-revenue').value = r.revenue;
            if(r.date) document.getElementById('edit-date').value = r.date.split('T')[0];
            document.getElementById('diary-market').value = r.market;
            document.getElementById('diary-mood').value = r.mood;
            const tbody = document.getElementById('edit-items-body');
            tbody.innerHTML = '';
            r.items.forEach(i => window.addItemRow(i.name, i.qty, i.unitPrice, i.note || ""));
            document.getElementById('editor-view').classList.remove('hidden');
            window.switchTab('record'); window.recalc();
            document.getElementById('editor-view').scrollIntoView({ behavior: 'smooth' });
        };

        window.viewRecordDetails = (id) => {
            const r = records.find(rec => rec.id === id);
            if (!r) return;
            document.getElementById('view-date').innerText = r.date.split('T')[0];
            document.getElementById('view-revenue').innerText = r.revenue.toLocaleString();
            
            const profitEl = document.getElementById('view-profit');
            profitEl.innerText = (r.profit || 0).toLocaleString();
            if ((r.profit || 0) < 0) { profitEl.className = "text-2xl font-black text-orange-600"; } 
            else { profitEl.className = "text-2xl font-black text-green-700"; }

            document.getElementById('view-market').innerText = r.market || "æœªè¨˜éŒ„";
            document.getElementById('view-mood').innerText = r.mood || "æœªè¨˜éŒ„";
            document.getElementById('view-items-tbody').innerHTML = r.items.map(i => {
                const noteHtml = i.note ? `<div class="text-[10px] text-purple-600 mt-1">ğŸ’¬ ${i.note}</div>` : '';
                return `<tr class="border-b border-gray-50"><td class="py-2 text-xs font-bold">${i.name} ${noteHtml}</td><td class="py-2 text-center text-xs text-gray-400">${i.unitPrice?.toLocaleString() || 0} x ${i.qty}</td><td class="py-2 text-right font-medium text-xs sm:text-sm text-gray-500">${(i.cost || 0).toLocaleString()}</td></tr>`;
            }).join('');
            document.getElementById('detail-modal').classList.remove('hidden');
        };

        window.viewDailyReport = (dateStr) => {
            const record = records.filter(r => r.date.startsWith(dateStr)).pop();
            if (record) { window.viewRecordDetails(record.id); } 
            else { showToast("æŸ¥ç„¡è©²æ—¥è©³ç´°è³‡æ–™", "error"); }
        };

        window.renderCalendar = () => {
            const picker = document.getElementById('calendar-month-picker');
            let date = new Date(picker.value + "-01");
            if (isNaN(date.getTime())) date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth(); 
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            const monthPrefix = `${year}-${String(month + 1).padStart(2, '0')}`;
            const monthRecords = records.filter(r => r.date.startsWith(monthPrefix));
            const dailyMap = {};
            
            monthRecords.forEach(r => {
                const day = r.date.split('-')[2];
                if (!dailyMap[day]) dailyMap[day] = { revenue: 0, profit: 0, count: 0, id: r.id };
                dailyMap[day].revenue += (r.revenue || 0);
                dailyMap[day].profit += (r.profit || 0);
                dailyMap[day].count += 1;
                dailyMap[day].id = r.id; 
            });

            const operatingDays = Object.keys(dailyMap).length;
            const restDays = daysInMonth - operatingDays;
            
            let totalMonthRevenue = 0;
            let totalMonthProfit = 0;
            Object.values(dailyMap).forEach(d => {
                totalMonthRevenue += d.revenue;
                totalMonthProfit += d.profit;
            });
            const totalMonthSplit = totalMonthProfit * 0.5;

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = "bg-gray-50/30 rounded-xl min-h-[70px] sm:min-h-[90px]";
                calendarGrid.appendChild(emptyCell);
            }

            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayStr = String(day).padStart(2, '0');
                const data = dailyMap[dayStr];
                const isToday = isCurrentMonth && today.getDate() === day;
                const hasData = data && data.revenue > 0;
                
                // ğŸŸ¢ æ–°å¢ï¼šè¨ˆç®—æ¯ä¸€å¤©çš„è¾²æ›†
                const targetDate = new Date(year, month, day);
                let lunarText = "";
                try {
                    if (typeof Lunar !== 'undefined') {
                        const l = Lunar.fromDate(targetDate);
                        // å¦‚æœæ˜¯åˆä¸€ï¼Œé¡¯ç¤ºæœˆä»½ (å¦‚: æ­£æœˆ)ï¼Œå¦å‰‡é¡¯ç¤ºæ—¥æœŸ (å¦‚: åˆäºŒ)
                        if (l.getDay() === 1) lunarText = l.getMonthInChinese() + "æœˆ";
                        else lunarText = l.getDayInChinese();
                        
                        // å¦‚æœæœ‰ç¯€æ°£ (å¦‚: ç«‹æ˜¥)ï¼Œå„ªå…ˆé¡¯ç¤ºç¯€æ°£
                        const jq = l.getJieQi();
                        if (jq) lunarText = jq;
                    }
                } catch (e) {}

                const fullDate = `${monthPrefix}-${dayStr}`;
                const cell = document.createElement('div');
                
                let className = `p-1 sm:p-2 rounded-xl flex flex-col items-center justify-start min-h-[80px] sm:min-h-[100px] border transition relative gap-0.5 sm:gap-1 `;
                className += isToday ? 'bg-yellow-50 border-yellow-300 shadow ring-1 ring-yellow-200 ' : 'bg-white border-gray-100 ';
                className += hasData ? 'cursor-pointer hover:bg-blue-50 hover:shadow-md ' : 'bg-gray-50/50 ';
                cell.className = className;
                
                if(hasData) {
                    cell.setAttribute('onclick', `window.viewDailyReport('${fullDate}')`);
                }

                // ğŸŸ¢ ä¿®æ”¹ï¼šåŠ å¤§å­—é«”ï¼Œå„ªåŒ–è€èŠ±çœ¼é–±è®€é«”é©—
                let content = `
                    <div class="w-full flex justify-between items-baseline px-0.5 mb-1">
                        <span class="text-lg sm:text-2xl font-black ${isToday ? 'text-yellow-800' : 'text-gray-800'}">${day}</span>
                        <span class="text-xs sm:text-sm font-bold ${isToday ? 'text-yellow-700' : 'text-gray-500'}">${lunarText}</span>
                    </div>
                `;

                if (hasData) {
                    const profitColor = data.profit < 0 ? 'text-orange-600' : 'text-green-600';
                    const profitSign = data.profit < 0 ? '-' : '+';
                    const profitVal = Math.abs(data.profit); 
                    
                    content += `<div class="text-center w-full mt-auto">
                        <p class="text-xs sm:text-sm font-black text-blue-700 leading-tight mb-0.5">$${(data.revenue/1000).toFixed(1)}k</p>
                        <p class="text-[10px] sm:text-xs font-bold ${profitColor} leading-tight">${profitSign}$${(profitVal/1000).toFixed(1)}k</p>
                    </div>`;
                } else {
                    content += `<div class="h-full flex items-center justify-center -mt-3"><span class="text-xs font-bold text-gray-300 bg-green-50 px-2 py-1 rounded-full text-green-700">ä¼‘</span></div>`;
                }
                cell.innerHTML = content;
                calendarGrid.appendChild(cell);
            }

            const statsContainer = document.getElementById('calendar-stats');
            if(statsContainer) {
                const profitColor = totalMonthProfit < 0 ? 'text-orange-600' : 'text-green-600';
                statsContainer.innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 bg-gray-50 rounded-2xl p-4 mt-4 shadow-sm">
                        <div class="text-center">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸ“… ç‡Ÿæ¥­å¤©æ•¸</p>
                            <p class="text-lg font-black text-blue-600">${operatingDays} <span class="text-xs text-gray-400 font-normal">å¤©</span></p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸ˜´ ä¼‘æ¯å¤©æ•¸</p>
                            <p class="text-lg font-black text-gray-400">${restDays} <span class="text-xs text-gray-300 font-normal">å¤©</span></p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸ’° ç¸½ç‡Ÿæ¥­é¡</p>
                            <p class="text-lg font-black text-blue-600">$${(totalMonthRevenue/1000).toFixed(1)}k</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸ“ˆ ç¸½åˆ©æ½¤</p>
                            <p class="text-lg font-black ${profitColor}">$${(totalMonthProfit/1000).toFixed(1)}k</p>
                        </div>
                        <div class="text-center col-span-2 sm:col-span-1">
                            <p class="text-xs text-gray-500 font-bold mb-1">ğŸ¤ ç¸½åˆ†æ½¤ (50%)</p>
                            <p class="text-lg font-black text-orange-500">$${(Math.max(0, totalMonthSplit)/1000).toFixed(1)}k</p>
                        </div>
                    </div>`;
            }
        };

        window.downloadExcel = () => {
            const filterVal = document.getElementById('report-filter').value;
            const filterSelect = document.getElementById('report-filter');
            const selectedText = filterSelect.options[filterSelect.selectedIndex].text.replace('ğŸ“… ', '').replace('ğŸ—“ï¸ ', '').replace(' (å…¨å¹´)', '');
            let exportData = records;
            if (filterVal !== 'all') exportData = records.filter(r => r.date.startsWith(filterVal));
            if (!exportData.length) return showToast("ç›®å‰ç¯©é¸ç¯„åœç„¡è³‡æ–™", "error");

            const wb = XLSX.utils.book_new();
            const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

            // 1. è£½ä½œã€Œæ¯æ—¥ç‡Ÿæ”¶ç¸½è¡¨ã€ (Sheet 1)
            const summaryData = exportData.map(r => {
                const dateObj = new Date(r.date);
                const dayStr = isNaN(dateObj.getDay()) ? '' : dayNames[dateObj.getDay()];
                return {
                    "æ—¥æœŸ": r.date.split('T')[0],
                    "æ˜ŸæœŸ": dayStr,
                    "ç‡Ÿæ¥­é¡": r.revenue,
                    "ç¸½æˆæœ¬": r.totalCost || 0,
                    "æ·¨åˆ©": r.profit || 0,
                    "åˆ†æ½¤ (50%)": r.split,
                    "è²·æ°£è©•åƒ¹": r.market,
                    "å¿ƒæƒ…æ—¥è¨˜": r.mood
                };
            });
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "æ¯æ—¥ç‡Ÿæ”¶ç¸½è¡¨");

            // 2. è£½ä½œã€Œé€²è²¨æˆæœ¬æ˜ç´°ã€ (Sheet 2)
            const detailData = [];
            exportData.forEach(r => {
                const dateStr = r.date.split('T')[0];
                const dateObj = new Date(r.date);
                const dayStr = isNaN(dateObj.getDay()) ? '' : dayNames[dateObj.getDay()];
                
                if (r.items && r.items.length > 0) {
                    r.items.forEach(item => {
                        detailData.push({
                            "æ—¥æœŸ": dateStr,
                            "æ˜ŸæœŸ": dayStr,
                            "å“é …åç¨±": item.name,
                            "æ•¸é‡": item.qty,
                            "å–®åƒ¹": item.unitPrice,
                            "å°è¨ˆæˆæœ¬": item.cost,
                            "å‚™è¨»": item.note || "" // å‚™è¨»ç¨ç«‹ä¸€æ¬„
                        });
                    });
                }
            });
            const wsDetail = XLSX.utils.json_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, wsDetail, "é€²è²¨æˆæœ¬æ˜ç´°");

            XLSX.writeFile(wb, `ç‡Ÿé‹å ±è¡¨_${selectedText}.xlsx`);
        };

        window.downloadStatsExcel = () => {
            const filterVal = document.getElementById('stats-filter').value;
            const filterSelect = document.getElementById('stats-filter');
            const selectedText = filterSelect.options[filterSelect.selectedIndex].text.replace('ğŸ“… ', '').replace('ğŸ—“ï¸ ', '').replace(' (å…¨å¹´)', '');
            let displayRecords = records;
            if (filterVal !== 'all') displayRecords = records.filter(r => r.date.startsWith(filterVal));
            if (!displayRecords.length) return showToast("ç›®å‰ç¯©é¸ç¯„åœç„¡è³‡æ–™", "error");
            const itemStats = {};
            displayRecords.forEach(r => {
                r.items.forEach(i => {
                    const name = i.name;
                    if (!itemStats[name]) itemStats[name] = { qty: 0, cost: 0, notes: [] };
                    itemStats[name].qty += (i.qty || 0);
                    itemStats[name].cost += (i.cost || 0);
                    if(i.note) itemStats[name].notes.push(i.note);
                });
            });
            const sortedItems = Object.keys(itemStats).map(key => ({ "å“é …åç¨±": key, "ç¸½æ¡è³¼æ•¸é‡": itemStats[key].qty, "ç¸½æ¡è³¼æˆæœ¬": itemStats[key].cost, "å‚™è¨»æ‘˜è¦": itemStats[key].notes.slice(0, 5).join('; ') })).sort((a, b) => b["ç¸½æ¡è³¼æˆæœ¬"] - a["ç¸½æ¡è³¼æˆæœ¬"]);
            const ws = XLSX.utils.json_to_sheet(sortedItems);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æˆæœ¬çµ±è¨ˆ"); 
            XLSX.writeFile(wb, `æˆæœ¬çµ±è¨ˆå ±è¡¨_${selectedText}.xlsx`);
        };

        window.switchTab = (tab) => {
            document.getElementById('page-work').classList.toggle('hidden', tab !== 'work');
            document.getElementById('page-record').classList.toggle('hidden', tab !== 'record');
            document.getElementById('page-report').classList.toggle('hidden', tab !== 'report');
            document.getElementById('page-stats').classList.toggle('hidden', tab !== 'stats');
            document.getElementById('page-ai').classList.toggle('hidden', tab !== 'ai'); 
            document.getElementById('page-calendar').classList.toggle('hidden', tab !== 'calendar'); 

            ['work', 'record', 'report', 'stats', 'ai', 'calendar'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                if (t === tab) {
                    btn.className = 'flex-1 py-3 text-center bg-blue-600 text-white rounded-xl font-bold transition text-xs sm:text-base whitespace-nowrap shadow-md';
                } else {
                    btn.className = 'flex-1 py-3 text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl';
                }
            });

            if(tab === 'report') renderReport();
            if(tab === 'stats') renderItemStats();
            if(tab === 'calendar') renderCalendar();
            if(tab === 'work') renderWorkStatsTable(); // Add this
        };

        function updateFilterOptions() {
            const yearSet = new Set(), monthSet = new Set();
            records.forEach(r => {
                let dateStr = r.date;
                if(dateStr.includes('T')) dateStr = dateStr.split('T')[0];
                const parts = dateStr.split('-');
                if(parts.length >= 2) { yearSet.add(parts[0]); monthSet.add(`${parts[0]}-${parts[1]}`); }
            });
            const sortedYears = Array.from(yearSet).sort().reverse();
            const sortedMonths = Array.from(monthSet).sort().reverse();
            let optionsHtml = '<option value="all">ğŸ“… å…¨éƒ¨æœŸé–“</option>';
            sortedYears.forEach(y => { optionsHtml += `<option value="${y}" class="font-bold text-blue-700">ğŸ—“ï¸ ${y}å¹´ (å…¨å¹´)</option>`; });
            sortedMonths.forEach(m => { const [y, mon] = m.split('-'); optionsHtml += `<option value="${m}">${y}å¹´ ${mon}æœˆ</option>`; });
            const filters = ['report-filter', 'stats-filter', 'ai-filter'];
            filters.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.innerHTML !== optionsHtml) el.innerHTML = optionsHtml;
            });
        }

        window.scrollToSection = (id) => {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        window.renderReport = () => {
            const filterVal = document.getElementById('report-filter').value;
            const filterSelect = document.getElementById('report-filter');
            const selectedText = filterSelect.options[filterSelect.selectedIndex].text.replace('ğŸ“… ', '').replace('ğŸ—“ï¸ ', '').replace(' (å…¨å¹´)', '');
            const tbody = document.getElementById('report-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            let displayRecords = records;
            if (filterVal !== 'all') displayRecords = records.filter(r => r.date.startsWith(filterVal));
            let totalSplit = 0, totalRevenue = 0, totalProfit = 0;
            const itemTotals = {}; 
            
            // Charts Data Preparation
            const trendData = [...displayRecords].sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort ascending for chart
            const weekdayStats = Array(7).fill(0).map(() => ({ totalProfit: 0, totalRevenue: 0, totalCost: 0, count: 0 }));

            // ğŸŸ¢ æ–°å¢ï¼šè¨ˆç®—å€é–“å…§çš„ç†è«–é€±æ¬¡ (ç¸½å…±æœ‰å¹¾å€‹é€±ä¸€ã€é€±äºŒ...)
            let startDate, endDate;
            const today = new Date();
            
            if (filterVal === 'all') {
                if (displayRecords.length > 0) {
                    // è‹¥æ˜¯å…¨éƒ¨æœŸé–“ï¼Œå–ç¬¬ä¸€ç­†è·Ÿæœ€å¾Œä¸€ç­†è³‡æ–™çš„æ—¥æœŸç•¶ç¯„åœ
                    const sortedDates = displayRecords.map(r => new Date(r.date)).sort((a,b) => a-b);
                    startDate = sortedDates[0];
                    endDate = sortedDates[sortedDates.length - 1];
                } else {
                    startDate = today; endDate = today;
                }
            } else if (filterVal.length === 4) { // å¹´ä»½ (e.g. 2025)
                startDate = new Date(`${filterVal}-01-01`);
                endDate = new Date(`${filterVal}-12-31`);
                if (endDate > today) endDate = today; // æœªä¾†æ—¥æœŸä¸è¨ˆå…¥ä¼‘æ¯
            } else { // æœˆä»½ (e.g. 2025-02)
                startDate = new Date(`${filterVal}-01`);
                // å–å¾—è©²æœˆæœ€å¾Œä¸€å¤©
                endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
                if (endDate > today) endDate = today; // æœªä¾†æ—¥æœŸä¸è¨ˆå…¥ä¼‘æ¯
            }

            const theoreticalWeekdays = Array(7).fill(0); // index 0 is Sunday
            if (startDate && endDate) {
                let loopDate = new Date(startDate);
                // é¿å…ç„¡çª®è¿´åœˆï¼Œè¨­å®šä¸€å€‹ä¿éšªé‚Šç•Œ
                while (loopDate <= endDate) {
                    theoreticalWeekdays[loopDate.getDay()]++;
                    loopDate.setDate(loopDate.getDate() + 1);
                }
            }

            if (displayRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-300">è©²æœŸé–“ç„¡è³‡æ–™</td></tr>';
            } else {
                displayRecords.forEach(r => {
                    totalSplit += r.split || 0; totalRevenue += r.revenue || 0; totalProfit += (r.profit || 0);
                    // r.items.forEach(i => itemTotals[i.name] = (itemTotals[i.name] || 0) + (i.cost || 0)); // No longer needed for chart, but keeping harmless
                    const dateDisplay = r.date.includes('T') ? r.date.split('T')[0] : r.date;
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    
                    const profitColor = (r.profit || 0) < 0 ? 'text-orange-600' : 'text-green-600';
                    
                    tr.innerHTML = `<td class="py-3 px-2"><div class="font-bold text-gray-800 text-xs sm:text-base">${dateDisplay}</div><div class="flex gap-2 mt-1"><button onclick="window.viewRecordDetails('${r.id}')" class="text-[10px] text-green-600 font-bold">è©³æƒ…</button><button onclick="window.editRecord('${r.id}')" class="text-[10px] text-blue-500 font-bold">ä¿®æ”¹</button><button onclick="window.confirmDelete('${r.id}')" class="text-[10px] text-red-400 font-bold">åˆªé™¤</button></div></td><td class="py-3 px-2 text-right text-xs sm:text-sm">${r.revenue.toLocaleString()}</td><td class="py-3 px-2 text-right text-gray-400 text-xs sm:text-sm">${(r.totalCost || 0).toLocaleString()}</td><td class="py-3 px-2 text-right font-bold ${profitColor} text-xs sm:text-sm">${(r.profit || 0).toLocaleString()}</td><td class="py-3 px-2 text-right font-bold text-orange-600 text-xs sm:text-sm">${(r.split || 0).toLocaleString()}</td>`;
                    tbody.appendChild(tr);

                    // Weekday Stats Accumulation
                    const dayIndex = new Date(r.date).getDay(); // 0-6 (Sun-Sat)
                    weekdayStats[dayIndex].totalProfit += (r.profit || 0);
                    weekdayStats[dayIndex].totalRevenue += (r.revenue || 0); // ğŸŸ¢ æ–°å¢ï¼šç´¯ç©ç‡Ÿæ”¶
                    weekdayStats[dayIndex].totalCost += (r.totalCost || 0); // ğŸŸ¢ æ–°å¢ï¼šç´¯ç©æˆæœ¬
                    weekdayStats[dayIndex].count += 1;
                });
            }
            document.getElementById('stat-total-split').innerText = Math.max(0, totalSplit).toLocaleString();
            document.getElementById('stat-total-revenue').innerText = totalRevenue.toLocaleString();
            
            const totalProfitEl = document.getElementById('stat-total-profit');
            totalProfitEl.innerText = totalProfit.toLocaleString();
            totalProfitEl.className = totalProfit < 0 ? "font-bold text-orange-600" : "font-bold text-green-600";
            
            const labelEl = document.getElementById('stat-split-label');
            if(labelEl) labelEl.innerText = filterVal === 'all' ? "ç´¯ç©ç¸½åˆ†æ½¤ (50%)" : `${selectedText} åˆ†æ½¤ (50%)`;
            
            // ğŸŸ¢ æº–å‚™åœ–è¡¨æ¨™ç±¤ (å«å·¥ä½œ/ä¼‘æ¯æ¬¡æ•¸)
            const dayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const chartLabels = dayNames.map((name, i) => {
                const work = weekdayStats[i].count;
                // ç†è«–å¤©æ•¸ - å¯¦éš›å·¥ä½œå¤©æ•¸ = ä¼‘æ¯å¤©æ•¸ (è‹¥æ˜¯è² æ•¸å‰‡æ­¸é›¶ï¼Œé¿å…ç•°å¸¸)
                const rest = Math.max(0, theoreticalWeekdays[i] - work);
                return [name, `ç‡Ÿé‹:${work} / ä¼‘:${rest}`];
            });

            // Render New Charts
            renderTrendChart(trendData);
            renderWeekdayChart(weekdayStats, chartLabels);
        };

        function renderTrendChart(data) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            if (trendChartInstance) trendChartInstance.destroy();
            
            const labels = data.map(r => r.date.split('T')[0].split('-').slice(1).join('/')); // MM/DD
            const revenues = data.map(r => r.revenue || 0);
            const profits = data.map(r => r.profit || 0);

            trendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç‡Ÿæ”¶',
                            data: revenues,
                            backgroundColor: 'rgba(59, 130, 246, 0.3)',
                            borderRadius: 4,
                            order: 2
                        },
                        {
                            label: 'æ·¨åˆ©',
                            data: profits,
                            type: 'line',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            pointRadius: 3,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += '$' + context.parsed.y.toLocaleString(); }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderWeekdayChart(stats, labels) {
            const ctx = document.getElementById('weekdayChart');
            if (!ctx) return;
            if (weekdayChartInstance) weekdayChartInstance.destroy();

            // 1. è¨ˆç®—å…¨é«”å¹³å‡æ•¸æ“šï¼Œä½œç‚ºåŸºæº–ç·š
            let totalRev = 0, totalCost = 0, totalCount = 0;
            // æ‰¾å‡ºç‡Ÿæ¥­å¤©æ•¸æœ€å¤šçš„é‚£ä¸€å¤© (ä¾‹å¦‚é€±å…­ç‡Ÿæ¥­ 4 æ¬¡)ï¼Œç”¨ä¾†åˆ¤æ–·å“ªäº›å¤©æ˜¯ã€Œå°‘ç‡Ÿæ¥­ã€çš„ç‰¹ä¾‹
            let maxDaysOpen = 0;

            const avgProfits = [];
            
            stats.forEach(s => {
                totalRev += s.totalRevenue;
                totalCost += s.totalCost;
                totalCount += s.count;
                if (s.count > maxDaysOpen) maxDaysOpen = s.count;
                
                const avgP = s.count > 0 ? Math.round(s.totalProfit / s.count) : 0;
                avgProfits.push(avgP);
            });

            const globalAvgCost = totalCount > 0 ? totalRev > 0 ? (totalCost / totalCount) : 0 : 0;
            
            // æ‰¾å‡ºç‡Ÿæ”¶æœ€ä½çš„æ—¥å­ (æ’é™¤æ²’æœ‰ç‡Ÿæ¥­çš„æ—¥å­)
            let minRevenue = Infinity;
            let maxProfit = -Infinity;
            
            stats.forEach((s, i) => {
                if (s.count > 0) {
                    const avgR = s.totalRevenue / s.count;
                    const avgP = s.totalProfit / s.count;
                    if (avgR < minRevenue) minRevenue = avgR;
                    if (avgP > maxProfit) maxProfit = avgP;
                }
            });

            // 2. æ™ºæ…§åˆ¤æ–·èˆ‡ä¸Šè‰²
            const bgColors = [];
            // ç°¡åŒ– X è»¸æ¨™ç±¤ï¼Œåªä¿ç•™æ˜ŸæœŸå¹¾ï¼Œè©³ç´°è³‡è¨Šæ”¾ Tooltip
            const cleanLabels = labels.map((labelArr, i) => {
                const dayName = labelArr[0]; // e.g. "é€±ä¸€"
                const s = stats[i];
                
                if (s.count === 0) {
                    bgColors.push('rgba(229, 231, 235, 0.5)'); // ç„¡è³‡æ–™ï¼šæ·ºç°
                    return dayName;
                }

                const avgC = s.totalCost / s.count;
                const avgR = s.totalRevenue / s.count;
                const avgP = s.totalProfit / s.count;
                
                // æ¨™è¨˜é‚è¼¯
                let color = 'rgba(59, 130, 246, 0.6)'; // é è¨­ï¼šè—è‰²
                let icon = '';

                // ç‰¹ä¾‹åˆ¤æ–·ï¼šå¦‚æœé€™å¤©ç‡Ÿæ¥­æ¬¡æ•¸å¾ˆå°‘ (ä¾‹å¦‚å°‘æ–¼æœ€å¸¸ç‡Ÿæ¥­å¤©æ•¸çš„ä¸€åŠ)ï¼Œæ¨™è¨˜ç‚ºã€Œå°‘ã€
                // é€™æ¨£æ‚¨å°±çŸ¥é“ç¦®æ‹œä¸€çš„é«˜ç²åˆ©å¯èƒ½æ˜¯å› ç‚ºåªé–‹äº†ä¸€å¤©
                const isRare = maxDaysOpen > 1 && s.count < (maxDaysOpen * 0.5);

                // A. åˆ¤æ–·ç²åˆ©ç‹ (åˆ©æ½¤æœ€é«˜)
                if (avgP === maxProfit && maxProfit > 0) {
                    color = 'rgba(234, 179, 8, 0.8)'; // é‡‘è‰²
                    icon = 'ğŸ‘‘';
                }
                // B. åˆ¤æ–·é€²è²¨æ—¥ (æˆæœ¬é«˜æ–¼å¹³å‡ 15%)
                else if (globalAvgCost > 0 && avgC > globalAvgCost * 1.15) {
                    color = 'rgba(249, 115, 22, 0.7)'; // æ©˜è‰²
                    icon = 'ğŸ“¦';
                }
                // C. åˆ¤æ–·å»ºè­°å…¬ä¼‘ (ç‡Ÿæ”¶æœ€ä½)
                else if (avgR === minRevenue && minRevenue < Infinity) {
                    color = 'rgba(156, 163, 175, 0.6)'; // ç°è‰²
                    icon = 'ğŸ’¤';
                }

                // å¦‚æœæ¨£æœ¬æ•¸å¤ªå°‘ï¼Œå¼·åˆ¶æ¨™è¨»
                if (isRare) {
                    icon = 'âš ï¸'; // ä»£è¡¨æ•¸æ“šæ¨£æœ¬å°‘ï¼Œåƒè€ƒåƒ¹å€¼éœ€ä¿ç•™
                }

                bgColors.push(color);
                return icon ? `${dayName} ${icon}` : dayName;
            });

            weekdayChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cleanLabels, 
                    datasets: [{
                        label: 'å¹³å‡ç²åˆ©',
                        data: avgProfits,
                        backgroundColor: bgColors,
                        borderRadius: 6,
                        borderWidth: 0,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                title: (context) => {
                                    const i = context[0].dataIndex;
                                    const fullLabel = labels[i]; // å–å›åŸå§‹è©³ç´°æ¨™ç±¤ "é€±ä¸€ (ç‡Ÿé‹:X / ä¼‘:Y)"
                                    return `${fullLabel[0]} (${fullLabel[1]})`;
                                },
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const s = stats[idx];
                                    if(s.count === 0) return 'ç„¡ç‡Ÿæ¥­è³‡æ–™';
                                    
                                    const avgRev = Math.round(s.totalRevenue / s.count);
                                    const avgCost = Math.round(s.totalCost / s.count);
                                    const avgProf = Math.round(s.totalProfit / s.count);

                                    return [
                                        `ğŸ“… ç‡Ÿæ¥­å¤©æ•¸: ${s.count} å¤©`, 
                                        `ğŸ’° å¹³å‡ç‡Ÿæ”¶: $${avgRev.toLocaleString()}`,
                                        `ğŸ’¸ å¹³å‡æˆæœ¬: $${avgCost.toLocaleString()}`,
                                        `ğŸ“‰ å¹³å‡ç²åˆ©: $${avgProf.toLocaleString()}`
                                    ];
                                },
                                afterBody: (context) => {
                                    const idx = context[0].dataIndex;
                                    const s = stats[idx];
                                    if (maxDaysOpen > 1 && s.count < (maxDaysOpen * 0.5)) {
                                        return '\nâš ï¸ æ­¤æ—¥ç‡Ÿæ¥­æ¬¡æ•¸è¼ƒå°‘\nå¹³å‡å€¼å¯èƒ½å—å–®æ—¥æ¥µç«¯å€¼å½±éŸ¿';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 12, weight: 'bold' },
                                color: '#6b7280'
                            }
                        }
                    }
                }
            });
            
            // 3. æ¸…çˆ½çš„å¡ç‰‡å¼åœ–ä¾‹ (Grid Layout)
            const legendContainer = document.createElement('div');
            legendContainer.className = "w-full mt-4";
            legendContainer.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-600 font-medium">
                    <div class="flex items-center gap-2 bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                        <span class="text-base">ğŸ‘‘</span> 
                        <div>
                            <span class="block font-bold text-yellow-700">ç²åˆ©ç‹</span>
                            <span class="text-[10px] text-yellow-600/70">å¹³å‡è³ºæœ€å¤š</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-orange-50 p-2 rounded-lg border border-orange-100">
                        <span class="text-base">ğŸ“¦</span>
                        <div>
                            <span class="block font-bold text-orange-700">é€²è²¨æ—¥</span>
                            <span class="text-[10px] text-orange-600/70">æˆæœ¬é«˜æ–¼å¹³å‡</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <span class="text-base">ğŸ’¤</span>
                        <div>
                            <span class="block font-bold text-gray-700">æ·¡å­£/å»ºè­°å…¬ä¼‘</span>
                            <span class="text-[10px] text-gray-500">å¹³å‡ç‡Ÿæ”¶æœ€ä½</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-100">
                        <span class="text-base">âš ï¸</span>
                        <div>
                            <span class="block font-bold text-blue-700">æ¨£æœ¬æ•¸å°‘</span>
                            <span class="text-[10px] text-blue-600/70">éå¸¸æ…‹ç‡Ÿæ¥­æ—¥</span>
                        </div>
                    </div>
                </div>
                <div class="mt-2 text-[10px] text-gray-400 text-center flex items-center justify-center gap-1">
                    <span>ğŸ’¡</span> 
                    <span>æ•¸æ“šå·²é€£å‹•ä¸Šæ–¹æ—¥æœŸç¯©é¸ (${document.getElementById('report-filter').options[document.getElementById('report-filter').selectedIndex].text})ï¼Œåƒ…è¨ˆç®—å¯¦éš›æœ‰ç‡Ÿæ¥­çš„å¤©æ•¸å¹³å‡ã€‚</span>
                </div>
            `;
            
            // æ¸…é™¤èˆŠçš„åœ–ä¾‹ä¸¦åŠ å…¥æ–°çš„
            const chartContainer = ctx.parentElement;
            if (chartContainer.nextElementSibling && !chartContainer.nextElementSibling.id?.includes('chart-')) {
                chartContainer.nextElementSibling.remove();
            }
            chartContainer.after(legendContainer);
        }

        window.renderItemStats = () => {
            const filterVal = document.getElementById('stats-filter').value;
            const tbody = document.getElementById('stats-tbody');
            const tbodyRanking = document.getElementById('profit-ranking-tbody'); 
            if (!tbody) return;
            tbody.innerHTML = '';
            tbodyRanking.innerHTML = '';
            let displayRecords = records;
            if (filterVal !== 'all') displayRecords = records.filter(r => r.date.startsWith(filterVal));
            let totalPeriodRevenue = 0, totalPeriodCost = 0, totalPeriodProfit = 0, totalPeriodQty = 0;
            const itemStats = {};
            displayRecords.forEach(r => {
                totalPeriodRevenue += (r.revenue || 0);
                totalPeriodCost += (r.totalCost || 0);
                totalPeriodProfit += (r.profit || 0);
                r.items.forEach(i => {
                    const name = i.name;
                    if (!itemStats[name]) itemStats[name] = { qty: 0, cost: 0, notes: [] };
                    itemStats[name].qty += (i.qty || 0);
                    itemStats[name].cost += (i.cost || 0); 
                    totalPeriodQty += (i.qty || 0);
                });
            });
            document.getElementById('card-revenue').innerText = `$${totalPeriodRevenue.toLocaleString()}`;
            document.getElementById('card-cost').innerText = `$${totalPeriodCost.toLocaleString()}`;
            
            const cardProfitEl = document.getElementById('card-profit');
            cardProfitEl.innerText = `$${totalPeriodProfit.toLocaleString()}`;
            cardProfitEl.className = totalPeriodProfit < 0 ? "text-2xl font-black text-orange-600" : "text-2xl font-black text-green-600";

            document.getElementById('card-qty').innerText = `${totalPeriodQty.toLocaleString()}`;
            const sortedItems = Object.keys(itemStats).map(key => ({ name: key, ...itemStats[key], percent: totalPeriodCost > 0 ? (itemStats[key].cost / totalPeriodCost * 100).toFixed(1) : 0 })).sort((a, b) => b["ç¸½æ¡è³¼æˆæœ¬"] - a["ç¸½æ¡è³¼æˆæœ¬"]);
            if (sortedItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-300">è©²æœŸé–“ç„¡è³‡æ–™</td></tr>';
            } else {
                sortedItems.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    const rank = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : (index + 1);
                    tr.innerHTML = `<td class="py-4 px-2 font-black text-lg text-gray-700 w-12 text-center">${rank}</td><td class="py-4 px-2 font-bold text-blue-800 text-sm sm:text-base">${item.name}</td><td class="py-4 px-2 text-center font-bold text-gray-600 bg-gray-50 rounded-lg">${item.qty}</td><td class="py-4 px-2 text-right font-bold text-gray-600">$${item.cost.toLocaleString()}</td><td class="py-4 px-2 text-right text-xs text-gray-400">${item.percent}%</td>`;
                    tbody.appendChild(tr);
                });
            }
            const sortedProfits = [...displayRecords].sort((a, b) => b.profit - a.profit).slice(0, 10);
            if (sortedProfits.length === 0) {
                tbodyRanking.innerHTML = '<tr><td colspan="3" class="p-5 text-center text-gray-300">ç„¡è³‡æ–™</td></tr>';
            } else {
                sortedProfits.forEach((r, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    const rank = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : (index + 1);
                    const dateDisplay = r.date.includes('T') ? r.date.split('T')[0] : r.date;
                    
                    const profitColor = (r.profit || 0) < 0 ? 'text-orange-600' : 'text-green-600';
                    
                    tr.innerHTML = `<td class="py-3 px-4 font-black text-gray-700 text-center">${rank}</td><td class="py-3 px-2 font-bold text-gray-800">${dateDisplay}</td><td class="py-3 px-4 text-right font-black ${profitColor}">$${(r.profit || 0).toLocaleString()}</td>`;
                    tbodyRanking.appendChild(tr);
                });
            }
        };

        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-50 text-white font-bold transition-all duration-300 animate-in slide-in-from-bottom-5 ${type === "error" ? "bg-red-600" : "bg-gray-800"}`;
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add("opacity-0"); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        window.openSettings = () => { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('api-key-input').value = myApiKey; };
        window.saveSettings = async () => {
            const newKey = document.getElementById('api-key-input').value.trim();
            if(!newKey) return showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key", "error");
            localStorage.setItem('user_gemini_api_key', newKey);
            myApiKey = newKey;
            if (currentUser) {
                try {
                    const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main');
                    await setDoc(configRef, { gemini_api_key: newKey }, { merge: true });
                    showToast("âœ… è¨­å®šå·²å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼");
                } catch (e) { showToast("âœ… è¨­å®šå·²å„²å­˜æ–¼æœ¬åœ°"); }
            } else { showToast("âœ… è¨­å®šå·²å„²å­˜æ–¼æœ¬åœ°"); }
            document.getElementById('settings-modal').classList.add('hidden');
        };

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; height: 240px; width: 100%; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .prose h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #1e3a8a; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { color: #0f172a; }
        /* æ—¥æ›†æ ¼å­çš„è‡ªé©æ‡‰ */
        .calendar-day-header { text-align: center; font-weight: bold; color: #9ca3af; font-size: 0.8rem; padding-bottom: 8px; }
        /* Scrollbar hide utility */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen pb-10">
    <!-- åˆå§‹è¼‰å…¥å‹•ç•« -->
    <div id="initial-loader" class="fixed inset-0 bg-white z-[60] flex items-center justify-center flex-col hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-500 font-bold">æ­£åœ¨è®€å–è³‡æ–™åº«...</p>
    </div>

    <!-- æ™‚é–“èª¿æ•´ç¢ºèª Modal (æ–°å¢) -->
    <div id="time-adjust-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center space-y-4 animate-in zoom-in-95 duration-200">
            <div class="text-4xl">â±ï¸</div>
            <h3 id="time-modal-title" class="text-xl font-bold text-gray-800">ç¢ºèªæ™‚é–“</h3>
            <p class="text-gray-500 text-sm">åª½åª½ï¼Œè«‹ç¢ºèªä¸€ä¸‹è¦è¨˜éŒ„çš„æ™‚é–“å°ä¸å°å–”ï¼</p>
            
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <input type="datetime-local" id="time-input" class="w-full bg-transparent font-bold text-lg text-center outline-none text-blue-600">
            </div>

            <button id="btn-delete-time" onclick="window.deleteTime()" class="hidden w-full text-red-500 hover:bg-red-50 py-2 rounded-xl text-sm font-bold border border-red-100 mb-2 transition">ğŸ—‘ï¸ åˆªé™¤ç´€éŒ„</button>

            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('time-adjust-modal').classList.add('hidden')" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button id="btn-confirm-time" onclick="window.confirmTime()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">ç¢ºå®šä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 text-center space-y-4 animate-in zoom-in-95 duration-200">
            <div class="text-5xl">ğŸ—‘ï¸</div>
            <h3 class="text-xl font-bold text-gray-800">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <p class="text-gray-500 text-sm">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œè«‹ç¢ºèªæ‚¨è¦åˆªé™¤é€™ç­†ç´€éŒ„ã€‚</p>
            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('delete-modal').classList.add('hidden'); pendingDeleteId = null;" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="window.performDelete()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-red-600">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- å“é …å°ç…§è¡¨ Modal -->
    <div id="mapping-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 space-y-4 animate-in zoom-in-95 duration-200 h-[80vh] flex flex-col">
            <div class="flex justify-between items-center border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">ğŸ“¦ å“é …åç¨±ç®¡ç†</h3>
                <button onclick="document.getElementById('mapping-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-800 text-2xl">âœ•</button>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="flex flex-1 gap-2 items-center">
                    <input type="text" id="mapping-alias" placeholder="åˆ¥å (å¦‚: apple)" class="flex-1 border border-gray-300 rounded-xl p-3 text-sm min-w-0 focus:border-blue-500 outline-none transition">
                    <span class="self-center text-gray-400">âœ</span>
                    <input type="text" id="mapping-standard" placeholder="æ¨™æº–å (å¦‚: è˜‹æœ)" class="flex-1 border border-gray-300 rounded-xl p-3 text-sm min-w-0 focus:border-blue-500 outline-none transition">
                </div>
                <button id="btn-add-mapping" onclick="window.addMapping()" class="bg-blue-600 text-white py-3 sm:py-2 px-6 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition shrink-0">ï¼‹ æ–°å¢</button>
            </div>
            
            <div class="flex-1 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-500 sticky top-0">
                        <tr><th class="p-2 text-left">åˆ¥å</th><th class="p-2"></th><th class="p-2 text-left">æ¨™æº–åç¨±</th><th class="p-2"></th></tr>
                    </thead>
                    <tbody id="mapping-tbody" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

    <nav class="bg-blue-700 text-white p-3 shadow-lg sticky top-0 z-40 flex justify-between items-center">
        <div class="flex flex-col">
            <div class="flex items-center gap-2">
                <h1 class="text-lg sm:text-xl font-bold">ğŸ“Š ç‡Ÿé‹åŠ©ç†</h1>
            </div>
            <div id="header-clock" class="text-[10px] sm:text-xs text-blue-100 font-mono mt-0.5">--/--/-- --:--</div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="window.openMappingModal()" class="bg-blue-800 p-2 rounded-full hover:bg-blue-600 transition shadow-inner" title="ç®¡ç†å“é …åç¨±">
                <span class="relative">ğŸ“¦<span class="absolute -top-1 -right-1 text-[8px] bg-green-400 rounded-full w-2 h-2"></span></span>
            </button>
            <button onclick="window.openSettings()" class="bg-blue-800 p-2 rounded-full hover:bg-blue-600 transition shadow-inner" title="è¨­å®š API Key">âš™ï¸</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 space-y-6">
        <div class="flex bg-white p-1 rounded-2xl shadow-sm border overflow-x-auto">
            <button id="btn-tab-work" onclick="switchTab('work')" class="flex-1 py-3 min-w-[80px] text-center bg-blue-600 text-white rounded-xl font-bold transition text-xs sm:text-base whitespace-nowrap shadow-md">ç‡Ÿé‹æ‰“å¡</button>
            <button id="btn-tab-record" onclick="switchTab('record')" class="flex-1 py-3 min-w-[80px] text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl">æƒæè¨˜å¸³</button>
            <button id="btn-tab-report" onclick="switchTab('report')" class="flex-1 py-3 min-w-[80px] text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl">ç‡Ÿé‹å ±è¡¨</button>
            <button id="btn-tab-stats" onclick="switchTab('stats')" class="flex-1 py-3 min-w-[80px] text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl">æˆæœ¬åˆ†æ</button>
            <button id="btn-tab-calendar" onclick="switchTab('calendar')" class="flex-1 py-3 min-w-[80px] text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl">ç‡Ÿé‹æ—¥æ›†</button>
            <button id="btn-tab-ai" onclick="switchTab('ai')" class="flex-1 py-3 min-w-[80px] text-center text-gray-500 font-bold transition text-xs sm:text-base whitespace-nowrap hover:bg-gray-100 rounded-xl">AI è¨ºæ–·</button>
        </div>
        
        <!-- é é¢ 0: ç‡Ÿé‹æ‰“å¡ (Work Session & Forecast) -->
        <section id="page-work" class="hidden space-y-6">
            <!-- ä¸ŠåŠéƒ¨: ç‡Ÿé‹ç‹€æ…‹ (New UI) -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
                <div id="work-status-badge" class="text-center mb-4">
                    <!-- Dynamic Status Badge -->
                    <span class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold">ğŸ’¤ å°šæœªç‡Ÿæ¥­</span>
                </div>
                
                <div id="work-action-area">
                    <!-- Dynamic Buttons -->
                </div>

                <div class="mt-4 text-center text-sm text-gray-400 font-bold bg-orange-50/50 py-2 rounded-lg" id="today-lunar-info"></div>
            </div>

            <!-- ä¸‹åŠéƒ¨: AI è²·æ°£é å ±ç³»çµ± -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <!-- ğŸŸ¢ ä¿®æ­£æ¨™é¡Œï¼šç§»é™¤(å°å—å¸‚)ï¼Œæ”¹å›ç°¡æ½”ç‰ˆ -->
                    <h2 class="text-xl font-bold text-indigo-900 flex items-center gap-2">ğŸ”® é å ±å°ˆå€</h2>
                    <p class="text-[10px] text-indigo-400 bg-indigo-50 px-2 py-1 rounded">ç³»çµ±æ¯æ—¥è‡ªå‹•æ›´æ–° (ä»Šæ—¥ & æ˜æ—¥)</p>
                </div>

                <!-- ğŸŸ¢ ä¿®æ”¹ï¼šå°‡æœªä¾†ä¸€é€±å¤©æ°£ç§»åˆ°æœ€ä¸Šé¢ -->
                <div class="mb-6">
                    <p class="text-xs font-bold text-gray-400 mb-3 ml-1">ğŸ“… å°å—å¸‚æ°£æº«é å ± (æ¸…æ™¨ä½æº« / ç™½å¤©é«˜æº«) - æœªä¾†ä¸€é€±</p>
                    <div id="forecast-weather-container" class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide">
                        <div class="flex-1 text-center text-gray-400 text-xs py-4">æ­£åœ¨è¼‰å…¥æ°£è±¡è³‡è¨Š...</div>
                    </div>
                </div>

                <!-- 3å¤© AI é æ¸¬å¡ç‰‡ (ä»Šæ—¥ã€æ˜æ—¥ã€å¾Œå¤©) -->
                <div id="ai-forecast-cards" class="border-t border-gray-100 pt-6">
                    <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    <div class="text-center py-8 text-gray-400 text-sm animate-pulse">æ­£åœ¨å¹«åª½åª½åˆ†æå¤©æ°£èˆ‡è²·æ°£...</div>
                </div>
            </div>

            <!-- ç‡Ÿé‹çµ±è¨ˆå ±è¡¨ -->
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">ğŸ“ˆ ç‡Ÿé‹çµ±è¨ˆå ±è¡¨</h2>
                    <select id="work-stats-filter" onchange="window.renderWorkStatsTable()" class="text-sm border border-gray-200 rounded-lg px-2 py-1 bg-gray-50 outline-none">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>

                <!-- ğŸŸ¢ ä¿®æ”¹ï¼šå°‡ grid å¾ 3 æ”¹ç‚º 2 (æ‰‹æ©Ÿ) / 4 (é›»è…¦) ä»¥å®¹ç´ç¸½åˆ†æ½¤ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-center">
                    <div class="bg-blue-50 p-3 rounded-2xl">
                        <p class="text-[10px] text-blue-400 mb-1">å¹³å‡å·¥æ™‚</p>
                        <p id="stats-avg-hours" class="text-lg font-bold text-blue-700">-</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-2xl">
                        <p class="text-[10px] text-green-400 mb-1">ç¸½ç‡Ÿæ”¶</p>
                        <p id="stats-sum-revenue" class="text-lg font-bold text-green-700">-</p>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-2xl">
                        <p class="text-[10px] text-orange-400 mb-1">ç¸½åˆ©æ½¤</p>
                        <p id="stats-sum-profit" class="text-lg font-bold text-orange-700">-</p>
                    </div>
                    <!-- ğŸŸ¢ æ–°å¢ï¼šç¸½åˆ†æ½¤å¡ç‰‡ -->
                    <div class="bg-purple-50 p-3 rounded-2xl">
                        <p class="text-[10px] text-purple-400 mb-1">ç¸½åˆ†æ½¤ (50%)</p>
                        <p id="stats-sum-split" class="text-lg font-bold text-purple-700">-</p>
                    </div>
                </div>

                <div class="overflow-x-auto max-h-[220px] overflow-y-auto relative">
                    <table class="w-full text-left min-w-[700px]">
                        <thead class="text-xs text-gray-400 border-b bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="p-2 whitespace-nowrap">æ—¥æœŸ</th>
                                <th class="p-2 whitespace-nowrap">é–‹æ”¤</th>
                                <th class="p-2 whitespace-nowrap">æ”¶æ”¤</th>
                                <th class="p-2 whitespace-nowrap">å·¥æ™‚</th>
                                <th class="p-2 text-right whitespace-nowrap">ç‡Ÿæ¥­é¡</th>
                                <th class="p-2 text-right whitespace-nowrap">åˆ©æ½¤</th>
                                <th class="p-2 text-right whitespace-nowrap">åˆ†æ½¤(50%)</th>
                                <th class="p-2 text-center whitespace-nowrap">é ä¼°è²·æ°£</th>
                                <th class="p-2 text-center whitespace-nowrap">å¯¦éš›è²·æ°£</th>
                            </tr>
                        </thead>
                        <tbody id="work-stats-tbody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- é é¢ 1: æƒæè¨˜å¸³ (ä¿æŒä¸è®Š) -->
        <section id="page-record" class="hidden space-y-4">
             <div class="bg-white p-10 rounded-3xl shadow-sm border-2 border-dashed border-blue-200 text-center cursor-pointer hover:bg-blue-50 transition" onclick="document.getElementById('fileInput').click()">
                <div id="upload-placeholder"><div class="text-6xl mb-4">ğŸ“¸</div><p class="text-xl font-bold text-gray-700">æ‹æ”è¨˜å¸³</p><p class="text-sm text-gray-400">AI æ­£åœ¨å¹«ä½ è¾¨è­˜æ—¥æœŸã€ç¸½ç‡Ÿæ”¶èˆ‡é€²è²¨æˆæœ¬...</p></div>
                <div id="preview-box" class="hidden"><img id="img-preview" class="max-h-72 mx-auto rounded-2xl shadow-lg mb-4"></div>
                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleFileUpload(event)">
            </div>
            
            <div id="loading-overlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center text-white text-center">
                <div class="bg-white/10 backdrop-blur-md p-10 rounded-3xl shadow-2xl">
                    <div class="inline-block animate-spin text-6xl mb-4">ğŸ</div>
                    <p class="text-xl font-bold">AI æ­£åœ¨é‹ä½œä¸­...</p>
                </div>
            </div>

            <div id="editor-view" class="hidden bg-white rounded-3xl shadow-xl p-6 space-y-6 border border-gray-100 animate-in slide-in-from-bottom-4 duration-500 relative">
                <div id="edit-mode-label" class="hidden absolute top-0 left-0 right-0 bg-green-100 text-green-800 text-center py-2 text-sm font-bold rounded-t-3xl">æ­£åœ¨ä¿®æ”¹èˆŠè³‡æ–™</div>

                <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 mt-4">
                    <label class="block text-sm font-bold text-yellow-800 mb-1">ğŸ“… å¸³å–®æ—¥æœŸ (AI è‡ªå‹•è¾¨è­˜)</label>
                    <input type="date" id="edit-date" class="w-full bg-transparent font-black text-xl text-gray-700 outline-none focus:border-yellow-400 transition">
                </div>

                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <label class="block text-sm font-bold text-blue-800">ä»Šæ—¥ç¸½ç‡Ÿæ¥­é¡ (æ‰‹å‹•/AIå¡«å¯«)</label>
                    <input type="number" id="edit-revenue" class="w-full text-4xl font-black bg-transparent border-b-2 border-blue-200 focus:border-blue-500 outline-none transition" oninput="window.recalc()">
                </div>

                <!-- ğŸŸ¢ éŒ¯èª¤é©—ç®—æç¤ºå€ -->
                <div id="validation-error-box" class="hidden bg-red-50 border border-red-200 rounded-xl p-3 my-2 space-y-1"></div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-gray-400 border-b">
                            <tr>
                                <th class="pb-3 min-w-[120px]">å“é …åç¨±(é€²è²¨)</th>
                                <th class="pb-3 w-14 text-center min-w-[60px]">æ•¸é‡</th>
                                <th class="pb-3 w-16 text-right min-w-[80px]">å–®åƒ¹</th>
                                <th class="pb-3 w-16 text-right min-w-[80px]">å°è¨ˆ</th>
                                <th class="pb-3 min-w-[120px]">å‚™è¨»</th>
                                <th class="pb-3 w-8"></th>
                            </tr>
                        </thead>
                        <tbody id="edit-items-body" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                <button onclick="window.addItemRow()" class="text-blue-600 font-bold text-sm hover:bg-blue-50 px-4 py-2 rounded-lg">+ æ–°å¢å“é …</button>
                
                <div class="grid grid-cols-3 gap-3 pt-6 border-t text-center">
                    <div class="bg-gray-100 p-4 rounded-2xl"><p class="text-[10px] text-gray-400">ç¸½æˆæœ¬(é€²è²¨)</p><p id="calc-cost" class="font-black text-gray-800 text-sm">0</p></div>
                    <div class="bg-green-100 p-4 rounded-2xl"><p class="text-[10px] text-green-500">æœ¬æ—¥åˆ©æ½¤</p><p id="calc-profit" class="font-black text-green-700 text-sm">0</p></div>
                    <div class="bg-orange-100 p-4 rounded-2xl"><p class="text-[10px] text-orange-500">åˆ†æ½¤ (50%)</p><p id="calc-split" class="font-black text-orange-700 text-sm">0</p></div>
                </div>
                <div class="space-y-4 pt-4">
                    <p class="text-sm font-bold text-gray-400 italic">ç‡Ÿé‹æ—¥è¨˜</p>
                    <select id="diary-market" class="w-full border-2 rounded-2xl p-4 bg-gray-50 font-bold outline-none focus:border-blue-400 transition appearance-none">
                        <option>éå¸¸å¥½ï¼Œå®¢äººçµ¡ç¹¹ä¸çµ•</option>
                        <option>é‚„ä¸éŒ¯ï¼Œç”Ÿæ„ç©©å®š</option>
                        <option>ä¸€èˆ¬èˆ¬ï¼Œæ­£å¸¸ç™¼æ®</option>
                        <option>æ¯”è¼ƒå†·æ¸…ï¼Œæ˜å¤©å†åŠªåŠ›</option>
                    </select>
                    <textarea id="diary-mood" rows="3" class="w-full border-2 rounded-2xl p-4 bg-gray-50 outline-none focus:border-blue-400 transition" placeholder="æœ‰ä»€éº¼æƒ³è¨˜ä¸‹ä¾†çš„äº‹å—ï¼Ÿ..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button id="btn-delete-record" onclick="window.deleteCurrentRecord()" class="hidden flex-1 bg-red-100 text-red-500 py-5 rounded-3xl font-bold text-lg shadow hover:bg-red-200 transition">åˆªé™¤</button>
                    <button id="btn-cancel-edit" onclick="window.resetEditor()" class="hidden flex-1 bg-gray-200 text-gray-600 py-5 rounded-3xl font-bold text-lg shadow hover:bg-gray-300 transition">å–æ¶ˆ</button>
                    <button id="btn-submit" onclick="window.submitRecord()" class="flex-[2] bg-blue-600 text-white py-5 rounded-3xl font-black text-xl shadow-xl hover:scale-[1.01] transition">å„²å­˜</button>
                </div>
            </div>
        </section>

        <!-- é é¢ 2: ç‡Ÿé‹å ±è¡¨ (Dashboard Layout) -->
        <section id="page-report" class="hidden space-y-6">
            <!-- (ä¿æŒä¸è®Š) -->
            <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border sticky top-0 z-30">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">ğŸ“Š ç‡Ÿé‹ç¸½è¦½</h3>
                <select id="report-filter" onchange="window.renderReport()" class="bg-gray-100 border-none text-sm font-bold py-2 px-4 rounded-xl outline-none cursor-pointer hover:bg-gray-200 transition">
                    <option value="all">ğŸ“… å…¨éƒ¨æœŸé–“</option>
                </select>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="window.scrollToSection('report-kpi')" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-full text-xs font-bold text-gray-600 shadow-sm hover:bg-gray-50 transition">ğŸ’° ç¸½åˆ†æ½¤ & KPI</button>
                <button onclick="window.scrollToSection('report-weekday-analysis')" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-full text-xs font-bold text-gray-600 shadow-sm hover:bg-gray-50 transition">ğŸ“… æ˜ŸæœŸåˆ¥åˆ†æ</button>
                <button onclick="window.scrollToSection('report-trend-analysis')" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-full text-xs font-bold text-gray-600 shadow-sm hover:bg-gray-50 transition">ğŸ“ˆ ç‡Ÿæ”¶è¶¨å‹¢</button>
                <button onclick="window.scrollToSection('report-history-list')" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-full text-xs font-bold text-gray-600 shadow-sm hover:bg-gray-50 transition">ğŸ“ æ­·å²æ˜ç´°</button>
                <button onclick="window.downloadExcel()" class="flex-shrink-0 bg-green-100 border border-green-200 px-4 py-2 rounded-full text-xs font-bold text-green-700 shadow-sm hover:bg-green-200 transition">ğŸ“¥ ä¸‹è¼‰å ±è¡¨</button>
            </div>

            <div id="report-kpi" class="bg-white p-6 rounded-3xl shadow-sm border flex flex-col justify-center space-y-4">
                <div class="text-center">
                    <p id="stat-split-label" class="text-gray-400 font-bold text-sm">ç´¯ç©ç¸½åˆ†æ½¤ (50%)</p>
                    <p id="stat-total-split" class="text-5xl font-black text-orange-600 mt-2">0</p>
                </div>
                <div class="grid grid-cols-2 gap-4 pt-6 border-t mt-2">
                    <div class="text-center">
                        <p class="text-gray-400 text-xs mb-1">ç¸½ç‡Ÿæ¥­é¡</p>
                        <p id="stat-total-revenue" class="text-xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400 text-xs mb-1">ç¸½æ·¨åˆ©</p>
                        <p id="stat-total-profit" class="text-xl font-bold text-green-600">0</p>
                    </div>
                </div>
            </div>

            <div id="report-weekday-analysis" class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm sm:text-base">ğŸ“… æ˜ŸæœŸåˆ¥ç²åˆ©åˆ†æ (å¹³å‡)</h3>
                <div class="chart-container"><canvas id="weekdayChart"></canvas></div>
            </div>

            <div id="report-trend-analysis" class="bg-white p-4 sm:p-6 rounded-3xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-sm sm:text-base">ğŸ“ˆ æ¯æ—¥ç‡Ÿæ”¶ vs åˆ©æ½¤è¶¨å‹¢</h3>
                <div class="chart-container" style="height: 300px;"><canvas id="trendChart"></canvas></div>
            </div>

            <div id="report-history-list" class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">ğŸ“ æ­·å²ç´€éŒ„æ˜ç´°</h3>
                    <span class="text-xs text-gray-400">(ä¾æ—¥æœŸæ’åº)</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[500px]">
                        <thead class="bg-white text-xs text-gray-400 font-bold border-b"><tr><th class="p-4">æ—¥æœŸ</th><th class="p-4 text-right">ç‡Ÿæ¥­é¡</th><th class="p-4 text-right">æˆæœ¬</th><th class="p-4 text-right">åˆ©æ½¤</th><th class="p-4 text-right">åˆ†æ½¤</th></tr></thead>
                        <tbody id="report-tbody" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- é é¢ 3: æˆæœ¬åˆ†æ (ä¿æŒä¸è®Š) -->
        <section id="page-stats" class="hidden space-y-6">
            <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">ğŸ† æˆæœ¬èˆ‡ç²åˆ©åˆ†æ</h3>
                <select id="stats-filter" onchange="window.renderItemStats()" class="bg-gray-100 border-none text-sm font-bold py-2 px-4 rounded-xl outline-none cursor-pointer hover:bg-gray-200 transition">
                    <option value="all">ğŸ“… å…¨éƒ¨æœŸé–“</option>
                </select>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-600 p-5 rounded-2xl shadow-lg text-white">
                    <p class="text-xs opacity-70 mb-1">ç¸½éŠ·å”®é¡ (Revenue)</p>
                    <p id="card-revenue" class="text-2xl font-black">$0</p>
                </div>
                <div class="bg-white border p-5 rounded-2xl shadow-sm">
                    <p class="text-xs text-gray-400 font-bold mb-1">ç¸½æˆæœ¬ (Cost)</p>
                    <p id="card-cost" class="text-2xl font-black text-gray-700">$0</p>
                </div>
                <div class="bg-white border p-5 rounded-2xl shadow-sm">
                    <p class="text-xs text-green-500 font-bold mb-1">ç¸½åˆ©æ½¤ (Profit)</p>
                    <p id="card-profit" class="text-2xl font-black text-green-600">$0</p>
                </div>
                <div class="bg-white border p-5 rounded-2xl shadow-sm">
                    <p class="text-xs text-purple-500 font-bold mb-1">æ¡è³¼ç¸½å“é …æ•¸</p>
                    <p id="card-qty" class="text-2xl font-black text-purple-600">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">ğŸ’° å“é …æˆæœ¬æ’è¡Œ (èŠ±è²»æœ€å¤š)</h3>
                        <button onclick="window.downloadStatsExcel()" class="bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow hover:bg-green-700 transition">ğŸ“¥ åŒ¯å‡º</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[300px]">
                            <thead class="bg-white text-xs text-gray-400 font-bold border-b">
                                <tr>
                                    <th class="p-3 w-10 text-center">#</th>
                                    <th class="p-3">å“é …</th>
                                    <th class="p-3 text-center">æ•¸é‡</th>
                                    <th class="p-3 text-right">ç¸½æˆæœ¬</th>
                                    <th class="p-3 text-right">ä½”æ¯”</th>
                                </tr>
                            </thead>
                            <tbody id="stats-tbody" class="divide-y divide-gray-50 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="p-5 border-b bg-gray-50">
                        <h3 class="font-bold text-gray-800">ğŸ“… æ¯æ—¥ç²åˆ©ç‹ (Top 10)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[300px]">
                            <thead class="bg-white text-xs text-gray-400 font-bold border-b">
                                <tr>
                                    <th class="p-3 w-10 text-center">#</th>
                                    <th class="p-3">æ—¥æœŸ</th>
                                    <th class="p-3 text-right text-green-600">ç•¶æ—¥æ·¨åˆ©</th>
                                </tr>
                            </thead>
                            <tbody id="profit-ranking-tbody" class="divide-y divide-gray-50 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- é é¢ 4: ç‡Ÿé‹æ—¥æ›† (ä¿æŒä¸è®Š) -->
        <section id="page-calendar" class="hidden space-y-6">
            <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border">
                <h3 class="font-bold text-gray-800 flex items-center gap-2">ğŸ—“ï¸ æœˆä»½æª¢è¦–</h3>
                <input type="month" id="calendar-month-picker" class="bg-gray-100 border-none text-sm font-bold py-2 px-4 rounded-xl outline-none cursor-pointer hover:bg-gray-200 transition" onchange="window.renderCalendar()">
            </div>
            <div class="bg-white p-4 rounded-3xl shadow-sm border">
                <div class="grid grid-cols-7 gap-1 mb-2">
                    <div class="calendar-day-header text-red-400">æ—¥</div>
                    <div class="calendar-day-header">ä¸€</div>
                    <div class="calendar-day-header">äºŒ</div>
                    <div class="calendar-day-header">ä¸‰</div>
                    <div class="calendar-day-header">å››</div>
                    <div class="calendar-day-header">äº”</div>
                    <div class="calendar-day-header text-green-600">å…­</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                <div id="calendar-stats"></div>
            </div>
        </section>

        <!-- é é¢ 5: AI è¨ºæ–· + å°è©± (ä¿æŒä¸è®Š) -->
        <section id="page-ai" class="hidden space-y-6">
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 p-8 rounded-3xl shadow-lg text-white">
                <h2 class="text-2xl font-bold mb-2">ğŸ¤– AI è²¼å¿ƒå…’å­</h2>
                <p class="opacity-80 mb-6 text-sm">é¸æ“‡æœˆä»½ï¼Œè®“æˆ‘å¹«æ‚¨åˆ†æç”Ÿæ„ç‹€æ³ï¼Œæˆ–è€…ç›´æ¥è·Ÿæˆ‘èŠèŠå¤©ã€‚</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <select id="ai-filter" class="flex-1 bg-white/90 border border-white/30 text-gray-900 text-sm font-bold py-3 px-4 rounded-xl outline-none cursor-pointer"><option value="all">ğŸ“… å…¨éƒ¨æœŸé–“</option></select>
                    <button id="btn-analyze" onclick="window.runAiAnalysis()" class="bg-white text-indigo-700 font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-50 transition whitespace-nowrap">âœ¨ å¹«åª½åª½åˆ†æ</button>
                </div>
            </div>
            <div id="ai-result-box" class="hidden bg-white p-8 rounded-3xl shadow-sm border border-gray-100 animate-in slide-in-from-bottom-4 duration-700">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">ğŸ“„ å…’å­çš„åˆ†æå ±å‘Š</h3><div class="flex gap-2"><button id="btn-save-analysis" onclick="window.saveAiAnalysis()" class="hidden bg-blue-600 text-white text-xs font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">ğŸ’¾ å„²å­˜å ±å‘Š</button><button onclick="window.exportAiAnalysis()" class="bg-green-600 text-white text-xs font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button></div></div>
                <div id="ai-result-content" class="prose prose-sm sm:prose max-w-none text-gray-600 leading-relaxed"></div>
            </div>

            <div id="ai-chat-box" class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-[500px]">
                <div class="p-4 bg-indigo-50 border-b flex justify-between items-center">
                    <h3 class="font-bold text-indigo-900 flex items-center gap-2">ğŸ’¬ è·Ÿå…’å­èŠèŠå¤©</h3>
                    <div class="flex gap-2">
                        <button id="btn-save-chat" onclick="window.saveChatSession()" class="text-xs bg-white border border-indigo-200 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-100">ğŸ’¾ å„²å­˜å°è©±</button>
                        <button onclick="window.downloadChatExcel()" class="text-xs bg-white border border-green-200 text-green-700 px-3 py-1 rounded-full hover:bg-green-50">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                    </div>
                </div>
                
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 bg-gray-50/50 space-y-4">
                    <div class="text-center text-gray-400 text-sm my-4">--- å…’å­éš¨æ™‚åœ¨ç·šï¼Œæ­¡è¿åª½åª½æå• ---</div>
                </div>

                <div class="p-4 bg-white border-t flex gap-2 items-end">
                    <textarea id="chat-input" class="flex-1 border rounded-2xl p-3 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none resize-none transition" rows="1" placeholder="æœ‰ä»€éº¼æƒ³å•å…’å­çš„å—ï¼Ÿ..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); window.sendChatMessage(); }"></textarea>
                    <button onclick="window.sendChatMessage()" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 shadow-lg transition">
                        â¤
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Settings/Detail Modals (ä¿æŒä¸è®Š) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6 space-y-4 animate-in zoom-in-95 duration-200">
            <div class="flex items-center gap-2 text-blue-800">
                <span class="text-2xl">âš™ï¸</span>
                <h2 class="text-xl font-bold">API é‡‘é‘°è¨­å®š</h2>
            </div>
            <p class="text-xs text-gray-500">è«‹è²¼ä¸Šæ‚¨çš„ Google Gemini API Keyã€‚é‡‘é‘°å°‡å„²å­˜æ–¼é›²ç«¯ï¼Œæ–¹ä¾¿è·¨è£ç½®ä½¿ç”¨ã€‚</p>
            <input type="text" id="api-key-input" class="w-full border-2 border-gray-200 rounded-xl p-3 text-sm" placeholder="AIzaSy...">
            <div class="flex gap-3 pt-4">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button onclick="window.saveSettings()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-2xl rounded-[2.5rem] overflow-y-auto max-h-[90vh] shadow-2xl p-8 space-y-8 animate-in zoom-in-95 duration-200">
            <div class="flex justify-between items-center"><h2 id="view-date" class="text-2xl font-black text-blue-700">æ—¥æœŸ</h2><button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="text-2xl font-bold">âœ•</button></div>
            <div id="view-no-image" class="hidden"></div> 
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-5 rounded-2xl"><p class="text-xs text-blue-400 font-bold mb-1">ç‡Ÿæ¥­é¡</p><p id="view-revenue" class="text-2xl font-black text-blue-700">0</p></div>
                <div class="bg-green-50 p-5 rounded-2xl"><p class="text-xs text-green-400 font-bold mb-1">æœ¬æ—¥åˆ©æ½¤</p><p id="view-profit" class="text-2xl font-black text-green-700">0</p></div>
            </div>
            <div>
                <h3 class="text-sm font-bold text-gray-400 mb-3 font-bold italic">ğŸ“‹ é€²è²¨/æˆæœ¬æ˜ç´°</h3>
                <table class="w-full text-sm">
                    <thead><tr class="text-gray-400 border-b text-left"><th class="pb-2">å“é …</th><th class="pb-2 text-center">å–®åƒ¹ x æ•¸é‡</th><th class="pb-2 text-right">å°è¨ˆ</th></tr></thead>
                    <tbody id="view-items-tbody" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
            <div class="border-t pt-6 space-y-4">
                <div><p class="text-xs text-gray-400 font-bold">ğŸ“¢ è²·æ°£ç‹€æ³</p><p id="view-market" class="font-bold text-gray-800"></p></div>
                <div><p class="text-xs text-gray-400 font-bold">ğŸ“ å¿ƒæƒ…æ—¥è¨˜</p><p id="view-mood" class="italic text-gray-600 bg-gray-50 p-4 rounded-xl whitespace-pre-wrap"></p></div>
            </div>
            <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="w-full bg-gray-900 text-white py-4 rounded-2xl font-bold transition hover:bg-black">é—œé–‰è©³æƒ…</button>
        </div>
    </div>
</body>
</html>